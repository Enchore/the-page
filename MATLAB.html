<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Fira+Code:wght@400;500;700&family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<title>MATLAB é—¯å…³å†’é™©</title>
<style>
/* Fonts loaded via link tags in head to avoid blocking */

*{margin:0;padding:0;box-sizing:border-box}
:root{
--orange:#FF6600;--orange-glow:#FF660066;--cyan:#00E5FF;--cyan-glow:#00E5FF44;
--bg:#0A0A12;--bg2:#12121F;--bg3:#1A1A2E;--surface:#16162A;--surface2:#1E1E38;
--text:#E8E8F0;--text2:#9090B0;--green:#00FF88;--red:#FF3366;--purple:#AA66FF;
--gold:#FFD700;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Noto Sans SC','Fira Code',monospace}
canvas#bgCanvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}

/* ===== SCREEN SYSTEM ===== */
.screen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10;display:none;flex-direction:column;align-items:center;justify-content:center;opacity:0;transition:opacity .5s}
.screen.active{display:flex;opacity:1}

/* ===== SPLASH ===== */
#splash{background:radial-gradient(ellipse at center,#1a1a3e 0%,#0a0a12 70%);z-index:10000}
.splash-title{font-family:'Orbitron',monospace;font-size:clamp(2rem,6vw,5rem);font-weight:900;background:linear-gradient(135deg,var(--orange),var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 60px var(--orange-glow);letter-spacing:.1em;animation:titlePulse 3s infinite}
.splash-sub{font-size:clamp(.9rem,2vw,1.4rem);color:var(--text2);margin:1rem 0 2.5rem;letter-spacing:.3em;font-weight:300}
@keyframes titlePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.3)}}
.btn{font-family:'Orbitron',monospace;font-size:1rem;padding:.8rem 2.5rem;border:2px solid var(--orange);background:transparent;color:var(--orange);cursor:pointer;letter-spacing:.15em;position:relative;overflow:hidden;transition:all .3s;text-transform:uppercase;border-radius:4px;z-index:10001}
.btn:hover{background:var(--orange);color:#000;box-shadow:0 0 30px var(--orange-glow),inset 0 0 30px #ffffff22}
.btn-cyan{border-color:var(--cyan);color:var(--cyan)}
.btn-cyan:hover{background:var(--cyan);color:#000;box-shadow:0 0 30px var(--cyan-glow)}
.btn-green{border-color:var(--green);color:var(--green)}
.btn-green:hover{background:var(--green);color:#000;box-shadow:0 0 30px #00ff8844}
.btn-sm{font-size:.75rem;padding:.5rem 1.2rem}

/* ===== HUB WORLD ===== */
#hub{background:var(--bg)}
.hub-header{position:absolute;top:0;left:0;right:0;padding:1.2rem 2rem;display:flex;justify-content:space-between;align-items:center;z-index:20;background:linear-gradient(to bottom,#0a0a12ee,transparent)}
.hub-stats{display:flex;gap:1.5rem;align-items:center;font-family:'Orbitron',monospace;font-size:.85rem}
.stat{display:flex;align-items:center;gap:.4rem}
.stat .icon{font-size:1.1rem}
.stat .val{color:var(--gold);font-weight:700}
.hub-title{font-family:'Orbitron',monospace;font-size:1.1rem;color:var(--orange);letter-spacing:.2em}

.hub-scene{width:100%;height:100%;perspective:1200px;display:flex;align-items:center;justify-content:center}
.hub-ring{position:relative;width:700px;height:700px;transform-style:preserve-3d;animation:hubSpin 40s linear infinite}
@keyframes hubSpin{from{transform:rotateX(-15deg) rotateY(0deg)}to{transform:rotateX(-15deg) rotateY(360deg)}}
.hub-ring:hover{animation-play-state:paused}

.portal{position:absolute;width:140px;height:160px;left:50%;top:50%;cursor:pointer;transform-style:preserve-3d;transition:all .4s cubic-bezier(.25,.46,.45,.94)}
.portal:hover{transform:translate(-50%,-50%) translateZ(40px) scale(1.12)}
.portal-inner{width:100%;height:100%;background:var(--surface);border:1px solid #ffffff15;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1rem;gap:.6rem;position:relative;overflow:hidden;backdrop-filter:blur(8px)}
.portal-inner::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--orange)}
.portal.locked .portal-inner{opacity:.4;filter:grayscale(.8)}
.portal.locked .portal-inner::before{background:var(--text2)}
.portal-icon{font-size:2.2rem;filter:drop-shadow(0 0 10px var(--orange-glow))}
.portal-name{font-family:'Noto Sans SC';font-size:.8rem;font-weight:700;text-align:center;color:var(--text)}
.portal-stars{display:flex;gap:2px;font-size:.75rem}
.portal-stars .star{color:#333}
.portal-stars .star.earned{color:var(--gold)}
.portal .lock-icon{position:absolute;font-size:1.5rem;color:var(--text2)}

/* ===== GAME SCREENS ===== */
.game-screen{background:var(--bg);flex-direction:column}
.game-header{width:100%;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;background:var(--surface);border-bottom:1px solid #ffffff0a;flex-shrink:0}
.game-header-left{display:flex;align-items:center;gap:1rem}
.back-btn{background:none;border:none;color:var(--text2);cursor:pointer;font-size:1.3rem;padding:.3rem;transition:color .2s}
.back-btn:hover{color:var(--orange)}
.game-title{font-family:'Orbitron';font-size:.9rem;color:var(--orange);letter-spacing:.15em}
.game-header-right{display:flex;gap:1.5rem;align-items:center;font-family:'Orbitron';font-size:.8rem}
.game-score{color:var(--gold)}
.game-lives{color:var(--red)}
.game-timer{color:var(--cyan)}
.game-body{flex:1;width:100%;overflow:auto;display:flex;align-items:center;justify-content:center;padding:1.5rem;position:relative}
.game-footer{width:100%;padding:.8rem 1.5rem;display:flex;justify-content:center;gap:1rem;background:var(--surface);border-top:1px solid #ffffff0a;flex-shrink:0}

/* ===== MEMORY CARD GAME ===== */
.memory-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;max-width:700px;width:100%}
.mem-card{aspect-ratio:3/4;perspective:800px;cursor:pointer}
.mem-card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .5s cubic-bezier(.4,0,.2,1)}
.mem-card.flipped .mem-card-inner,.mem-card.matched .mem-card-inner{transform:rotateY(180deg)}
.mem-card-front,.mem-card-back{position:absolute;inset:0;backface-visibility:hidden;border-radius:10px;display:flex;align-items:center;justify-content:center;padding:.7rem;text-align:center}
.mem-card-front{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--orange);font-family:'Orbitron';font-size:1.8rem;color:var(--orange)}
.mem-card-front::after{content:'M';font-size:2rem;opacity:.3}
.mem-card-back{transform:rotateY(180deg);border:1px solid #ffffff22}
.mem-card-back.type-func{background:linear-gradient(145deg,#1a2a1a,#0d1f0d);border-color:var(--green);font-family:'Fira Code';font-size:clamp(.65rem,1.5vw,.9rem);color:var(--green);font-weight:700}
.mem-card-back.type-desc{background:linear-gradient(145deg,#2a1a1a,#1f0d0d);border-color:var(--orange);font-size:clamp(.6rem,1.3vw,.8rem);color:var(--text);line-height:1.4}
.mem-card.matched{opacity:.5;pointer-events:none}
.mem-card.matched .mem-card-inner{transform:rotateY(180deg) scale(.95)}

/* ===== CODE BUILDER ===== */
.codebuilder-wrap{display:flex;gap:2rem;width:100%;max-width:900px;flex-wrap:wrap;justify-content:center}
.cb-task{width:100%;background:var(--surface);border:1px solid var(--cyan);border-radius:8px;padding:1rem 1.2rem;margin-bottom:.5rem}
.cb-task-label{font-size:.7rem;color:var(--cyan);font-family:'Orbitron';letter-spacing:.15em;margin-bottom:.4rem}
.cb-task-desc{font-size:.9rem;line-height:1.5;color:var(--text)}
.cb-dropzone{flex:1;min-width:300px;min-height:300px;background:var(--surface);border:2px dashed #ffffff15;border-radius:8px;padding:.8rem;display:flex;flex-direction:column;gap:6px;transition:border-color .2s}
.cb-dropzone.over{border-color:var(--orange)}
.cb-source{flex:1;min-width:250px;display:flex;flex-direction:column;gap:6px;padding:.8rem}
.cb-block{font-family:'Fira Code';font-size:.8rem;padding:.7rem 1rem;background:var(--bg3);border:1px solid #ffffff15;border-radius:6px;cursor:grab;user-select:none;transition:all .2s;color:var(--text);line-height:1.4}
.cb-block:hover{border-color:var(--orange);background:var(--surface2)}
.cb-block.dragging{opacity:.4;transform:scale(.95)}
.cb-block.correct{border-color:var(--green);background:#00ff8810}
.cb-block.wrong{border-color:var(--red);background:#ff336610;animation:shake .4s}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}

/* ===== BUG HUNTER ===== */
.bughunter-wrap{max-width:750px;width:100%}
.bh-desc{background:var(--surface);border-left:3px solid var(--red);padding:1rem;margin-bottom:1rem;border-radius:0 8px 8px 0;font-size:.85rem;color:var(--text2);line-height:1.5}
.bh-editor{background:#0d0d1a;border:1px solid #ffffff10;border-radius:8px;overflow:hidden}
.bh-editor-header{background:var(--surface);padding:.5rem 1rem;display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:var(--text2)}
.bh-editor-header .dot{width:8px;height:8px;border-radius:50%}
.bh-line{display:flex;align-items:flex-start;padding:.3rem 0;cursor:pointer;transition:background .15s;border-left:3px solid transparent}
.bh-line:hover{background:#ffffff06}
.bh-line.selected{background:#ff336615;border-left-color:var(--red)}
.bh-line.correct-bug{background:#00ff8815;border-left-color:var(--green)}
.bh-line.missed-bug{background:#ff660020;border-left-color:var(--orange)}
.bh-linenum{width:40px;text-align:right;padding-right:12px;color:#555;font-family:'Fira Code';font-size:.8rem;user-select:none;flex-shrink:0}
.bh-code{font-family:'Fira Code';font-size:.8rem;color:var(--text);white-space:pre;line-height:1.6}
.bh-lines{padding:.5rem 0}

/* ===== MATRIX ARENA ===== */
.matrix-wrap{display:flex;flex-direction:column;align-items:center;gap:1.5rem;max-width:800px;width:100%}
.matrix-display{display:flex;align-items:center;gap:1rem;flex-wrap:wrap;justify-content:center}
.matrix-grid{display:inline-grid;gap:2px;background:var(--surface);border:2px solid var(--cyan);border-radius:6px;padding:8px}
.matrix-cell{width:48px;height:48px;display:flex;align-items:center;justify-content:center;font-family:'Fira Code';font-size:1rem;font-weight:700;color:var(--cyan);background:var(--bg2);border-radius:4px}
.matrix-op{font-family:'Orbitron';font-size:1.5rem;color:var(--orange);padding:0 .5rem}
.matrix-eq{font-family:'Orbitron';font-size:1.5rem;color:var(--text2)}
.matrix-input-grid{display:inline-grid;gap:2px;background:var(--surface);border:2px solid var(--orange);border-radius:6px;padding:8px}
.matrix-input-cell{width:48px;height:48px;background:var(--bg);border:1px solid #ffffff15;border-radius:4px;color:var(--orange);font-family:'Fira Code';font-size:1rem;font-weight:700;text-align:center;outline:none}
.matrix-input-cell:focus{border-color:var(--orange);box-shadow:0 0 8px var(--orange-glow)}
.matrix-question{font-size:.9rem;color:var(--text2);text-align:center;line-height:1.5}

/* ===== SPEED TYPING ===== */
.terminal-wrap{max-width:700px;width:100%;background:#0a0a0f;border:1px solid #ffffff10;border-radius:8px;overflow:hidden;font-family:'Fira Code'}
.terminal-header{background:var(--surface);padding:.5rem 1rem;display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:var(--text2)}
.terminal-body{padding:1rem;min-height:300px;max-height:500px;overflow-y:auto}
.terminal-line{margin-bottom:.3rem;font-size:.85rem;line-height:1.5}
.terminal-prompt{color:var(--green)}
.terminal-output{color:var(--text2)}
.terminal-error{color:var(--red)}
.terminal-task{color:var(--cyan);font-size:.8rem;margin-bottom:.5rem;padding:.5rem;background:#00e5ff08;border-left:2px solid var(--cyan)}
.terminal-input-line{display:flex;align-items:center;gap:.5rem}
.terminal-input-line .prompt-symbol{color:var(--green);font-size:.85rem}
.terminal-input{flex:1;background:none;border:none;color:var(--text);font-family:'Fira Code';font-size:.85rem;outline:none;caret-color:var(--orange)}

/* ===== PLOT DETECTIVE ===== */
.plot-wrap{display:flex;gap:1.5rem;max-width:900px;width:100%;flex-wrap:wrap;justify-content:center;align-items:flex-start}
.plot-canvas-wrap{flex:1;min-width:300px;background:var(--surface);border:1px solid #ffffff10;border-radius:8px;padding:1rem;display:flex;flex-direction:column;align-items:center}
.plot-canvas-wrap canvas{width:100%;max-width:400px;aspect-ratio:4/3;border-radius:4px;background:#0d0d1a}
.plot-options{flex:1;min-width:280px;display:flex;flex-direction:column;gap:.6rem}
.plot-option{font-family:'Fira Code';font-size:.75rem;padding:.8rem 1rem;background:var(--surface);border:1px solid #ffffff15;border-radius:8px;cursor:pointer;transition:all .2s;color:var(--text);white-space:pre-wrap;line-height:1.5}
.plot-option:hover{border-color:var(--orange);background:var(--surface2)}
.plot-option.correct{border-color:var(--green);background:#00ff8815}
.plot-option.wrong{border-color:var(--red);background:#ff336615}

/* ===== MAZE ===== */
.maze-container{width:100%;height:100%;position:relative;overflow:hidden}
.maze-viewport{width:100%;height:100%;perspective:600px;display:flex;align-items:center;justify-content:center}
.maze-grid-wrap{transform-style:preserve-3d;transform:rotateX(55deg) rotateZ(0deg);transition:transform .3s}
.maze-grid{display:grid;gap:0;position:relative}
.maze-cell{width:40px;height:40px;position:relative;border:1px solid #ffffff08}
.maze-cell.wall{background:linear-gradient(145deg,#1a1a2e,#0d0d1a);border-color:#ffffff04;box-shadow:inset 0 0 10px #00000066}
.maze-cell.path{background:#12122044}
.maze-cell.player{background:var(--orange);box-shadow:0 0 20px var(--orange-glow);border-radius:4px;z-index:5}
.maze-cell.question-cell{background:#00e5ff15;border-color:var(--cyan);display:flex;align-items:center;justify-content:center;font-family:'Orbitron';font-size:.9rem;color:var(--cyan);text-shadow:0 0 8px var(--cyan-glow);animation:glowPulse 2s infinite}
.maze-cell.exit{background:var(--green);box-shadow:0 0 20px #00ff8844;border-radius:4px}
.maze-cell.visited{background:#ff660008}
.maze-question-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10000;background:var(--surface);border:2px solid var(--cyan);border-radius:12px;padding:1.5rem;max-width:450px;width:90%;box-shadow:0 0 60px #00000088,0 0 0 9999px #00000088}
.maze-question-popup h3{font-family:'Orbitron';font-size:.85rem;color:var(--cyan);margin-bottom:.8rem}
.maze-question-popup pre{font-family:'Fira Code';font-size:.8rem;background:var(--bg);padding:.8rem;border-radius:6px;margin-bottom:1rem;color:var(--text);overflow-x:auto}
.maze-question-popup .mq-options{display:flex;flex-direction:column;gap:.5rem}
.maze-question-popup .mq-opt{padding:.6rem .8rem;background:var(--bg2);border:1px solid #ffffff15;border-radius:6px;cursor:pointer;font-family:'Fira Code';font-size:.8rem;transition:all .15s}
.maze-question-popup .mq-opt:hover{border-color:var(--orange)}

/* ===== OUTPUT PREDICT (New Mode 8) ===== */
.output-wrap{max-width:700px;width:100%}
.output-code-box{background:#0d0d1a;border:1px solid #ffffff10;border-radius:8px;overflow:hidden;margin-bottom:1.5rem}
.output-code-header{background:var(--surface);padding:.5rem 1rem;display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:var(--text2)}
.output-code-body{padding:1rem;font-family:'Fira Code';font-size:.85rem;line-height:1.6;color:var(--text);white-space:pre-wrap}
.output-input-area{display:flex;flex-direction:column;gap:.8rem}
.output-label{font-size:.75rem;color:var(--cyan);font-family:'Orbitron';letter-spacing:.1em}
.output-textarea{width:100%;min-height:80px;background:var(--bg2);border:2px solid #ffffff15;border-radius:8px;padding:.8rem;font-family:'Fira Code';font-size:.85rem;color:var(--text);resize:vertical;outline:none;transition:border-color .2s}
.output-textarea:focus{border-color:var(--orange)}
.output-expected{margin-top:.5rem;padding:.8rem;background:#00ff8810;border:1px solid var(--green);border-radius:6px;font-family:'Fira Code';font-size:.85rem;color:var(--green);white-space:pre-wrap;display:none}
.output-expected.wrong-bg{background:#ff336610;border-color:var(--red);color:var(--red)}

/* ===== FILL BLANKS (New Mode 9) ===== */
.fill-wrap{max-width:750px;width:100%}
.fill-desc{background:var(--surface);border-left:3px solid var(--purple);padding:1rem;margin-bottom:1rem;border-radius:0 8px 8px 0;font-size:.85rem;color:var(--text2);line-height:1.5}
.fill-code-box{background:#0d0d1a;border:1px solid #ffffff10;border-radius:8px;overflow:hidden;margin-bottom:1rem}
.fill-code-body{padding:1rem;font-family:'Fira Code';font-size:.85rem;line-height:2;color:var(--text)}
.fill-blank{display:inline-block;min-width:80px;border-bottom:2px dashed var(--orange);padding:2px 6px;margin:0 2px;background:var(--bg2);font-family:'Fira Code';font-size:.85rem;color:var(--orange);outline:none;text-align:center;transition:all .2s;border-radius:3px 3px 0 0}
.fill-blank:focus{border-bottom-color:var(--cyan);background:var(--bg3)}
.fill-blank.correct{border-bottom-color:var(--green);color:var(--green);background:#00ff8810}
.fill-blank.wrong{border-bottom-color:var(--red);color:var(--red);background:#ff336610}

/* ===== RESULT OVERLAY ===== */
.result-overlay{position:fixed;inset:0;z-index:80;background:#0a0a12ee;display:none;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;backdrop-filter:blur(10px)}
.result-overlay.active{display:flex}
.result-stars{font-size:3rem;display:flex;gap:.5rem}
.result-stars .star{color:#333;transition:all .3s}
.result-stars .star.earned{color:var(--gold);text-shadow:0 0 20px #ffd70066;animation:starPop .5s cubic-bezier(.17,.67,.29,1.53)}
@keyframes starPop{0%{transform:scale(0) rotate(-30deg)}100%{transform:scale(1) rotate(0)}}
.result-score{font-family:'Orbitron';font-size:2rem;color:var(--orange)}
.result-msg{font-size:1rem;color:var(--text2);text-align:center;max-width:400px}

/* ===== PARTICLES ===== */
.particle{position:fixed;pointer-events:none;z-index:90;border-radius:50%;animation:particleFly 1s forwards}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--surface2);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--orange)}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  .hub-ring{width:500px;height:500px}
  .portal{width:100px;height:120px}
  .portal-icon{font-size:1.5rem}
  .portal-name{font-size:.65rem}
  .memory-grid{grid-template-columns:repeat(4,1fr);gap:8px;max-width:500px}
  .matrix-cell,.matrix-input-cell{width:36px;height:36px;font-size:.8rem}
  .codebuilder-wrap{flex-direction:column}
  .plot-wrap{flex-direction:column}
}
@media(max-width:500px){
  .hub-ring{width:360px;height:360px}
  .portal{width:80px;height:95px}
  .portal-icon{font-size:1.2rem}
  .portal-name{font-size:.55rem}
  .memory-grid{grid-template-columns:repeat(3,1fr)}
}

/* ===== SCANLINE OVERLAY ===== */
body::after{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none !important;background:repeating-linear-gradient(0deg,transparent,transparent 2px,#00000008 2px,#00000008 4px);opacity:.3;touch-action:none}

/* ===== GLOW PULSE FOR ACTIVE ELEMENTS ===== */
@keyframes glowPulse{0%,100%{box-shadow:0 0 5px var(--orange-glow)}50%{box-shadow:0 0 20px var(--orange-glow),0 0 40px #ff660022}}
.portal:not(.locked) .portal-inner{animation:glowPulse 3s infinite}

/* ===== UNLOCK REQUIREMENT LABELS ===== */
.portal.locked .portal-inner::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 5px,#ffffff03 5px,#ffffff03 10px)}

/* ===== CODE SYNTAX HIGHLIGHTING HELPERS ===== */
.kw{color:var(--cyan)}
.fn{color:var(--green)}
.str{color:var(--gold)}
.num{color:var(--orange)}
.cmt{color:#666;font-style:italic}

/* ===== MOBILE CONTROLS ===== */
.mobile-controls{position:absolute;bottom:1.5rem;right:1.5rem;display:grid;grid-template-columns:repeat(3,50px);grid-template-rows:repeat(3,50px);gap:4px;z-index:30}
.mobile-controls button{background:var(--surface);border:1px solid var(--orange);color:var(--orange);font-size:1.2rem;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:.7;transition:all .15s}
.mobile-controls button:active{background:var(--orange);color:#000;opacity:1}
@media(min-width:769px){.mobile-controls{display:grid;opacity:.5}}
@media(min-width:769px){.mobile-controls:hover{opacity:1}}

/* ===== MODE PICKER OVERLAY ===== */
.mode-picker-overlay{position:fixed;inset:0;z-index:10001;background:#000000cc;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.mode-picker-overlay.active{opacity:1;pointer-events:auto}
.mode-picker-box{background:var(--surface);border:2px solid var(--orange);border-radius:16px;padding:2rem;max-width:400px;width:90%;text-align:center}
.mode-picker-title{font-family:'Orbitron';font-size:1.1rem;color:var(--orange);margin-bottom:.3rem}
.mode-picker-sub{font-size:.8rem;color:var(--text2);margin-bottom:1.5rem}
.mode-picker-btns{display:flex;flex-direction:column;gap:.8rem}
.mode-pick-btn{padding:1rem;background:var(--bg2);border:1px solid #ffffff15;border-radius:10px;cursor:pointer;transition:all .2s;text-align:left}
.mode-pick-btn:hover{border-color:var(--cyan);background:var(--bg3)}
.mode-pick-btn .mpb-title{font-family:'Orbitron';font-size:.85rem;margin-bottom:.2rem}
.mode-pick-btn .mpb-desc{font-size:.7rem;color:var(--text2);line-height:1.4}
.mode-pick-btn.pick-normal .mpb-title{color:var(--cyan)}
.mode-pick-btn.pick-endless .mpb-title{color:var(--gold)}
.mode-pick-back{margin-top:1rem;font-size:.75rem;color:var(--text2);cursor:pointer;border:none;background:none;font-family:inherit}
.mode-pick-back:hover{color:var(--text)}
</style>
</head>
<body>
<canvas id="bgCanvas"></canvas>

<!-- SPLASH SCREEN -->
<div id="splash" class="screen active">
  <div class="splash-title">MATLAB</div>
  <div class="splash-sub">é—¯ å…³ å†’ é™©</div>
  <button class="btn" onclick="startGame()">å¯ åŠ¨ ç³» ç»Ÿ</button>
</div>

<!-- HUB WORLD -->
<div id="hub" class="screen">
  <div class="hub-header">
    <div class="hub-title">&#9670; ä»»åŠ¡å¤§å… &#9670;</div>
    <div class="hub-stats">
      <div class="stat"><span class="icon">&#9733;</span><span class="val" id="totalStars">0</span><span>/27</span></div>
      <div class="stat"><span class="icon">&#9670;</span><span class="val" id="totalScore">0</span></div>
    </div>
  </div>
  <div class="hub-scene">
    <div class="hub-ring" id="hubRing"></div>
  </div>
</div>

<!-- GAME SCREENS (dynamically populated) -->
<div id="gameMemory" class="screen game-screen"></div>
<div id="gameCodeBuilder" class="screen game-screen"></div>
<div id="gameBugHunter" class="screen game-screen"></div>
<div id="gameMatrix" class="screen game-screen"></div>
<div id="gameTerminal" class="screen game-screen"></div>
<div id="gamePlot" class="screen game-screen"></div>
<div id="gameMaze" class="screen game-screen"></div>
<div id="gameOutput" class="screen game-screen"></div>
<div id="gameFill" class="screen game-screen"></div>
<div id="gameEndless" class="screen game-screen"></div>

<!-- MODE PICKER OVERLAY -->
<div class="mode-picker-overlay" id="modePicker"></div>

<!-- RESULT OVERLAY -->
<div class="result-overlay" id="resultOverlay">
  <div class="result-stars" id="resultStars"></div>
  <div class="result-score" id="resultScore"></div>
  <div class="result-msg" id="resultMsg"></div>
  <div style="display:flex;gap:1rem;margin-top:1rem">
    <button class="btn btn-sm" onclick="goHub()">è¿”å›å¤§å…</button>
    <button class="btn btn-sm btn-cyan" onclick="replayMode()">å†æ¥ä¸€æ¬¡</button>
  </div>
</div>

<script>
// ===================== AUDIO ENGINE =====================
const AudioEngine = {
  ctx: null,
  init() {
    try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
  },
  play(type) {
    try {
      if (!this.ctx) this.init();
      if (!this.ctx) return;
      const c = this.ctx, now = c.currentTime;
      if (c.state === 'suspended') c.resume();
      const o = c.createOscillator(), g = c.createGain();
      o.connect(g); g.connect(c.destination);
      const presets = {
        click: { f: 800, d: .08, t: 'sine' },
        correct: { f: 523, d: .15, t: 'sine', f2: 659 },
        wrong: { f: 200, d: .2, t: 'sawtooth' },
        flip: { f: 1200, d: .06, t: 'sine' },
        star: { f: 880, d: .3, t: 'sine', f2: 1318 },
        type: { f: 600 + Math.random() * 400, d: .03, t: 'square' },
        complete: { f: 523, d: .5, t: 'sine' },
      };
      const p = presets[type] || presets.click;
      o.type = p.t; o.frequency.setValueAtTime(p.f, now);
      if (p.f2) o.frequency.linearRampToValueAtTime(p.f2, now + p.d);
      g.gain.setValueAtTime(.15, now);
      g.gain.exponentialRampToValueAtTime(.001, now + p.d);
      o.start(now); o.stop(now + p.d);
    } catch(e) {}
  }
};

// ===================== BACKGROUND PARTICLES =====================
const bgCanvas = document.getElementById('bgCanvas');
const bgCtx = bgCanvas.getContext('2d');
let bgParticles = [];
function initBg() {
  bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
  bgParticles = Array.from({length: 80}, () => ({
    x: Math.random() * bgCanvas.width, y: Math.random() * bgCanvas.height,
    vx: (Math.random() - .5) * .3, vy: (Math.random() - .5) * .3,
    r: Math.random() * 1.5 + .5, a: Math.random() * .5 + .1
  }));
}
function drawBg() {
  bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
  bgParticles.forEach(p => {
    p.x += p.vx; p.y += p.vy;
    if (p.x < 0) p.x = bgCanvas.width; if (p.x > bgCanvas.width) p.x = 0;
    if (p.y < 0) p.y = bgCanvas.height; if (p.y > bgCanvas.height) p.y = 0;
    bgCtx.beginPath(); bgCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    bgCtx.fillStyle = `rgba(255,102,0,${p.a})`; bgCtx.fill();
  });
  for (let i = 0; i < bgParticles.length; i++) {
    for (let j = i + 1; j < bgParticles.length; j++) {
      const dx = bgParticles[i].x - bgParticles[j].x;
      const dy = bgParticles[i].y - bgParticles[j].y;
      const d = Math.sqrt(dx * dx + dy * dy);
      if (d < 120) {
        bgCtx.beginPath();
        bgCtx.moveTo(bgParticles[i].x, bgParticles[i].y);
        bgCtx.lineTo(bgParticles[j].x, bgParticles[j].y);
        bgCtx.strokeStyle = `rgba(255,102,0,${.05 * (1 - d / 120)})`;
        bgCtx.stroke();
      }
    }
  }
  requestAnimationFrame(drawBg);
}
initBg(); drawBg();
window.addEventListener('resize', initBg);

// ===================== CELEBRATION PARTICLES =====================
function spawnParticles(x, y, color = '#FF6600', count = 12) {
  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const angle = (Math.PI * 2 / count) * i;
    const dist = 40 + Math.random() * 60;
    p.style.cssText = `left:${x}px;top:${y}px;width:6px;height:6px;background:${color};--tx:${Math.cos(angle)*dist}px;--ty:${Math.sin(angle)*dist}px`;
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 1000);
  }
}

// ===================== STATE MANAGEMENT =====================
let state = {
  totalScore: 0,
  stars: { memory:0, codebuilder:0, bughunter:0, matrix:0, terminal:0, plot:0, maze:0, output:0, fill:0, endless:0 },
  unlocked: ['memory', 'bughunter', 'maze', 'codebuilder', 'endless'],
  currentMode: null
};

function saveState() {
  localStorage.setItem('matlab_adventure_v2', JSON.stringify(state));
  const starsEl = document.getElementById('totalStars');
  const scoreEl = document.getElementById('totalScore');
  if (starsEl) starsEl.textContent = Object.values(state.stars).reduce((a, b) => a + b, 0);
  if (scoreEl) scoreEl.textContent = state.totalScore;
}
function loadState() {
  const s = localStorage.getItem('matlab_adventure_v2');
  if (s) { try { const parsed = JSON.parse(s); Object.assign(state, parsed); } catch(e){} }
  // Ensure new modes exist in stars
  if (!state.stars.output) state.stars.output = 0;
  if (!state.stars.fill) state.stars.fill = 0;
  checkUnlocks();
  saveState();
}
function checkUnlocks() {
  const total = Object.values(state.stars).reduce((a, b) => a + b, 0);
  if (!state.unlocked.includes('codebuilder')) state.unlocked.push('codebuilder');
  if (total >= 2 && !state.unlocked.includes('matrix')) state.unlocked.push('matrix');
  if (total >= 3 && !state.unlocked.includes('output')) state.unlocked.push('output');
  if (total >= 4 && !state.unlocked.includes('terminal')) state.unlocked.push('terminal');
  if (total >= 5 && !state.unlocked.includes('fill')) state.unlocked.push('fill');
  if (total >= 6 && !state.unlocked.includes('plot')) state.unlocked.push('plot');
  if (!state.unlocked.includes('endless')) state.unlocked.push('endless');
}

// ===================== SCREEN MANAGEMENT =====================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function startGame() {
  AudioEngine.init();
  AudioEngine.play('click');
  showScreen('hub');
  loadState();
  buildHub();
}

function goHub() {
  AudioEngine.play('click');
  state.currentMode = null;
  document.getElementById('resultOverlay').classList.remove('active');
  checkUnlocks();
  saveState();
  buildHub();
  showScreen('hub');
}

let lastMode = null;
function replayMode() {
  AudioEngine.play('click');
  document.getElementById('resultOverlay').classList.remove('active');
  if (lastMode) launchMode(lastMode);
}

// ===================== HUB WORLD =====================
const modes = [
  { id: 'memory', name: 'å‡½æ•°è®°å¿†ç¿»ç‰Œ', icon: 'ğŸƒ', screen: 'gameMemory' },
  { id: 'codebuilder', name: 'ä»£ç æ‹¼è£…', icon: 'ğŸ§©', screen: 'gameCodeBuilder' },
  { id: 'bughunter', name: 'BugçŒäºº', icon: 'ğŸ›', screen: 'gameBugHunter' },
  { id: 'matrix', name: 'çŸ©é˜µç«æŠ€åœº', icon: 'ğŸ”¢', screen: 'gameMatrix' },
  { id: 'output', name: 'è¾“å‡ºé¢„æµ‹', icon: 'ğŸ”®', screen: 'gameOutput' },
  { id: 'terminal', name: 'æé€Ÿç»ˆç«¯', icon: 'âŒ¨ï¸', screen: 'gameTerminal' },
  { id: 'fill', name: 'ä»£ç å¡«ç©º', icon: 'âœï¸', screen: 'gameFill' },
  { id: 'plot', name: 'å›¾å½¢ä¾¦æ¢', icon: 'ğŸ“Š', screen: 'gamePlot' },
  { id: 'maze', name: 'ä»£ç è¿·å®«', icon: 'ğŸ—ï¸', screen: 'gameMaze' },
  { id: 'endless', name: 'æ— å°½æ¨¡å¼', icon: 'â™¾ï¸', screen: 'gameEndless' },
];

function buildHub() {
  const ring = document.getElementById('hubRing');
  ring.innerHTML = '';
  const n = modes.length;
  const radius = Math.min(window.innerWidth, window.innerHeight) * .28;
  modes.forEach((m, i) => {
    const angle = (2 * Math.PI / n) * i - Math.PI / 2;
    const x = Math.cos(angle) * radius;
    const z = Math.sin(angle) * radius;
    const portal = document.createElement('div');
    const locked = !state.unlocked.includes(m.id);
    const unlockReqs = { matrix: 2, output: 3, terminal: 4, fill: 5, plot: 6 };
    const reqText = unlockReqs[m.id] ? `éœ€è¦ ${unlockReqs[m.id]} é¢—æ˜Ÿè§£é”` : '';
    portal.className = `portal${locked ? ' locked' : ''}`;
    portal.style.transform = `translate(-50%,-50%) translateX(${x}px) translateZ(${z}px) rotateY(${-((360/n)*i)}deg)`;
    const stars = [0,1,2].map(s => `<span class="star${s < state.stars[m.id] ? ' earned' : ''}">â˜…</span>`).join('');
    portal.innerHTML = `<div class="portal-inner">
      <div class="portal-icon">${m.icon}</div>
      <div class="portal-name">${m.name}</div>
      <div class="portal-stars">${stars}</div>
      ${locked ? `<div class="lock-icon">ğŸ”’</div><div style="position:absolute;bottom:6px;font-size:.5rem;color:var(--text2)">${reqText}</div>` : ''}
    </div>`;
    if (!locked) {
      portal.addEventListener('click', () => { AudioEngine.play('click'); launchMode(m.id); });
    }
    ring.appendChild(portal);
  });
}

function launchMode(id) {
  lastMode = id;
  state.currentMode = id;
  // Modes that support endless sub-mode
  const endlessModes = ['terminal', 'output', 'fill', 'bughunter', 'matrix', 'codebuilder', 'plot', 'maze'];
  if (endlessModes.includes(id)) {
    showModePicker(id);
  } else {
    doLaunchMode(id, false);
  }
}

function showModePicker(id) {
  const m = modes.find(m => m.id === id);
  const picker = document.getElementById('modePicker');
  picker.innerHTML = `<div class="mode-picker-box">
    <div class="mode-picker-title">${m.icon} ${m.name}</div>
    <div class="mode-picker-sub">é€‰æ‹©æ¸¸æˆæ¨¡å¼</div>
    <div class="mode-picker-btns">
      <div class="mode-pick-btn pick-normal" id="pickNormal">
        <div class="mpb-title">é—¯å…³æ¨¡å¼</div>
        <div class="mpb-desc">å›ºå®šé¢˜é‡ï¼Œå®Œæˆåè·å¾—æ˜Ÿçº§è¯„ä»·</div>
      </div>
      <div class="mode-pick-btn pick-endless" id="pickEndless">
        <div class="mpb-title">â™¾ï¸ æ— å°½æ¨¡å¼</div>
        <div class="mpb-desc">æ— é™å‡ºé¢˜ï¼Œè¿ç»­ç­”å¯¹åŠ åˆ†ï¼ŒæŒ‘æˆ˜æœ€é«˜è¿å‡»</div>
      </div>
    </div>
    <button class="mode-pick-back" id="pickBack">è¿”å›å¤§å…</button>
  </div>`;
  picker.classList.add('active');
  document.getElementById('pickNormal').addEventListener('click', () => {
    AudioEngine.play('click');
    picker.classList.remove('active');
    doLaunchMode(id, false);
  });
  document.getElementById('pickEndless').addEventListener('click', () => {
    AudioEngine.play('click');
    picker.classList.remove('active');
    doLaunchMode(id, true);
  });
  document.getElementById('pickBack').addEventListener('click', () => {
    AudioEngine.play('click');
    picker.classList.remove('active');
    state.currentMode = null;
  });
}

function doLaunchMode(id, endless) {
  if (endless) {
    initModeEndless(id);
    return;
  }
  switch(id) {
    case 'memory': initMemory(); break;
    case 'codebuilder': initCodeBuilder(); break;
    case 'bughunter': initBugHunter(); break;
    case 'matrix': initMatrix(); break;
    case 'terminal': initTerminal(); break;
    case 'plot': initPlot(); break;
    case 'maze': initMaze(); break;
    case 'output': initOutput(); break;
    case 'fill': initFill(); break;
    case 'endless': initEndless(); break;
  }
}

function showResult(modeId, score, maxScore) {
  const pct = score / maxScore;
  const stars = pct >= .9 ? 3 : pct >= .6 ? 2 : pct >= .3 ? 1 : 0;
  if (stars > state.stars[modeId]) state.stars[modeId] = stars;
  state.totalScore += score;
  saveState();
  const msgs = ['ç»§ç»­åŠªåŠ›ï¼', 'åˆçª¥é—¨å¾„', 'æ¸å…¥ä½³å¢ƒï¼', 'å¤§å¸ˆçº§è¡¨ç°ï¼'];
  document.getElementById('resultStars').innerHTML = [0,1,2].map((s,i) =>
    `<span class="star${i < stars ? ' earned' : ''}" style="animation-delay:${i*.2}s">${i < stars ? 'â˜…' : 'â˜†'}</span>`
  ).join('');
  document.getElementById('resultScore').textContent = `${score} / ${maxScore}`;
  document.getElementById('resultMsg').textContent = msgs[stars];
  setTimeout(() => {
    document.getElementById('resultOverlay').classList.add('active');
    if (stars > 0) AudioEngine.play('star');
  }, 300);
}

function makeGameHeader(title, screenId, extraHtml = '') {
  return `<div class="game-header">
    <div class="game-header-left">
      <button class="back-btn" onclick="goHub()">â—‚</button>
      <div class="game-title">${title}</div>
    </div>
    <div class="game-header-right">${extraHtml}</div>
  </div>`;
}

// ===================== MODE 1: MEMORY CARD FLIP =====================
const memoryData = [
  { func: 'linspace(a,b,n)', desc: 'ç”Ÿæˆä»aåˆ°bçš„nä¸ªç­‰è·ç‚¹' },
  { func: 'meshgrid(x,y)', desc: 'ç”ŸæˆäºŒç»´ç½‘æ ¼åæ ‡çŸ©é˜µ' },
  { func: 'zeros(m,n)', desc: 'åˆ›å»ºmÃ—nå…¨é›¶çŸ©é˜µ' },
  { func: 'ones(m,n)', desc: 'åˆ›å»ºmÃ—nå…¨ä¸€çŸ©é˜µ' },
  { func: 'eye(n)', desc: 'åˆ›å»ºné˜¶å•ä½çŸ©é˜µ' },
  { func: 'rand(m,n)', desc: 'ç”ŸæˆmÃ—nå‡åŒ€éšæœºçŸ©é˜µ' },
  { func: 'diag(v)', desc: 'ä»¥å‘é‡våˆ›å»ºå¯¹è§’çŸ©é˜µ' },
  { func: 'size(A)', desc: 'è¿”å›çŸ©é˜µAçš„è¡Œåˆ—æ•°' },
  { func: 'length(v)', desc: 'è¿”å›å‘é‡æœ€å¤§ç»´åº¦é•¿åº¦' },
  { func: 'reshape(A,m,n)', desc: 'å°†çŸ©é˜µAé‡å¡‘ä¸ºmÃ—n' },
  { func: "transpose(A) / A'", desc: 'çŸ©é˜µè½¬ç½®æ“ä½œ' },
  { func: 'inv(A)', desc: 'æ±‚çŸ©é˜µAçš„é€†çŸ©é˜µ' },
  { func: 'det(A)', desc: 'è®¡ç®—çŸ©é˜µAçš„è¡Œåˆ—å¼' },
  { func: 'eig(A)', desc: 'æ±‚çŸ©é˜µç‰¹å¾å€¼å’Œç‰¹å¾å‘é‡' },
  { func: 'fft(x)', desc: 'å¿«é€Ÿå‚…é‡Œå¶å˜æ¢' },
  { func: 'conv(a,b)', desc: 'å‘é‡å·ç§¯è¿ç®—' },
  { func: 'find(æ¡ä»¶)', desc: 'æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„ç´¢å¼•' },
  { func: 'sort(v)', desc: 'å¯¹å‘é‡å‡åºæ’åˆ—' },
  { func: 'max(A)', desc: 'è¿”å›æœ€å¤§å€¼(åŠç´¢å¼•)' },
  { func: 'sum(A)', desc: 'æ±‚å’Œ(æŒ‰åˆ—æˆ–å…¨éƒ¨)' },
];

function initMemory() {
  const screen = document.getElementById('gameMemory');
  const pairs = shuffle([...memoryData]).slice(0, 6);
  let cards = [];
  pairs.forEach(p => {
    cards.push({ type: 'func', text: p.func, pairId: p.func });
    cards.push({ type: 'desc', text: p.desc, pairId: p.func });
  });
  cards = shuffle(cards);
  let flipped = [], matched = 0, flips = 0, score = 0;
  const maxPairs = pairs.length;

  screen.innerHTML = makeGameHeader('å‡½æ•°è®°å¿†ç¿»ç‰Œ', 'gameMemory',
    `<span class="game-score">é…å¯¹: <span id="memMatched">0</span>/${maxPairs}</span>
     <span class="game-timer">ç¿»ç‰Œ: <span id="memFlips">0</span></span>`
  ) + `<div class="game-body"><div class="memory-grid" id="memGrid"></div></div>`;

  const grid = document.getElementById('memGrid');
  cards.forEach((c, i) => {
    const card = document.createElement('div');
    card.className = 'mem-card';
    card.dataset.idx = i;
    card.innerHTML = `<div class="mem-card-inner">
      <div class="mem-card-front"></div>
      <div class="mem-card-back type-${c.type}">${escHtml(c.text)}</div>
    </div>`;
    card.addEventListener('click', () => {
      if (flipped.length >= 2 || card.classList.contains('flipped') || card.classList.contains('matched')) return;
      AudioEngine.play('flip');
      card.classList.add('flipped');
      flipped.push({ el: card, data: c });
      flips++;
      document.getElementById('memFlips').textContent = flips;
      if (flipped.length === 2) {
        setTimeout(() => {
          if (flipped[0].data.pairId === flipped[1].data.pairId && flipped[0].data.type !== flipped[1].data.type) {
            flipped.forEach(f => f.el.classList.add('matched'));
            AudioEngine.play('correct');
            matched++;
            score += Math.max(10, 30 - flips);
            const rect = flipped[0].el.getBoundingClientRect();
            spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, '#00FF88');
            document.getElementById('memMatched').textContent = matched;
            if (matched === maxPairs) {
              setTimeout(() => showResult('memory', score, maxPairs * 30), 600);
            }
          } else {
            AudioEngine.play('wrong');
            flipped.forEach(f => f.el.classList.remove('flipped'));
          }
          flipped = [];
        }, 800);
      }
    });
    grid.appendChild(card);
  });
  showScreen('gameMemory');
}

// ===================== MODE 2: CODE BUILDER =====================
const codeBuilderData = [
  {
    task: 'åˆ›å»ºä¸€ä¸ª for å¾ªç¯ï¼Œè®¡ç®— 1 åˆ° 10 çš„ç´¯åŠ å’Œï¼Œå¹¶è¾“å‡ºç»“æœ',
    lines: ['total = 0;', 'for i = 1:10', '    total = total + i;', 'end', 'disp(total);'],
    explain: 'for å¾ªç¯ä» 1 éå†åˆ° 10ï¼Œæ¯æ¬¡æŠŠ i ç´¯åŠ åˆ° total ä¸Šã€‚æœ€ç»ˆ total = 55ã€‚disp() ç”¨äºåœ¨å‘½ä»¤çª—å£æ˜¾ç¤ºç»“æœã€‚',
    shuffled: null
  },
  {
    task: 'ç”Ÿæˆ 0 åˆ° 2pi çš„æ­£å¼¦æ›²çº¿å¹¶ç»˜å›¾ï¼Œæ·»åŠ æ ‡é¢˜å’Œæ ‡ç­¾',
    lines: ['x = linspace(0, 2*pi, 100);', 'y = sin(x);', 'plot(x, y);', "title('Sine Wave');", "xlabel('x'); ylabel('sin(x)');"],
    explain: 'linspace ç”Ÿæˆç­‰é—´è·å‘é‡ï¼Œsin è®¡ç®—æ­£å¼¦å€¼ï¼Œplot ç”»çº¿å›¾ã€‚title/xlabel/ylabel åˆ†åˆ«è®¾ç½®æ ‡é¢˜å’Œåæ ‡è½´æ ‡ç­¾ï¼Œæ³¨æ„é¡ºåºï¼šå…ˆç”Ÿæˆæ•°æ®å†ç”»å›¾å†æ·»åŠ æ ‡æ³¨ã€‚',
    shuffled: null
  },
  {
    task: 'å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—åŠå¾„ rï¼Œè¿”å›åœ†çš„é¢ç§¯',
    lines: ['function area = circleArea(r)', '    area = pi * r^2;', 'end'],
    explain: 'MATLAB å‡½æ•°ä»¥ function å¼€å¤´ï¼Œæ ¼å¼ä¸º function è¾“å‡º = å‡½æ•°å(è¾“å…¥)ã€‚pi æ˜¯å†…ç½®å¸¸é‡ã€‚å‡½æ•°ä½“ä»¥ end ç»“æŸã€‚',
    shuffled: null
  },
  {
    task: 'ç”¨ while å¾ªç¯æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äº 1000 çš„ 2 çš„å¹‚æ¬¡',
    lines: ['n = 1;', 'while n <= 1000', '    n = n * 2;', 'end', 'disp(n);'],
    explain: 'while å¾ªç¯åœ¨æ¡ä»¶ä¸º true æ—¶é‡å¤æ‰§è¡Œã€‚æ¯æ¬¡ n ç¿»å€ï¼ˆ1â†’2â†’4â†’...â†’512â†’1024ï¼‰ï¼Œå½“ n=1024 > 1000 æ—¶é€€å‡ºå¾ªç¯å¹¶æ˜¾ç¤ºã€‚',
    shuffled: null
  },
  {
    task: 'è¯»å–çŸ©é˜µ A çš„ç¬¬ 2 è¡Œç¬¬ 3 åˆ—å…ƒç´ ï¼Œä»¥åŠç¬¬ 1 è¡Œæ‰€æœ‰å…ƒç´ ',
    lines: ['A = [1 2 3; 4 5 6; 7 8 9];', 'element = A(2, 3);', 'firstRow = A(1, :);', 'disp(element);', 'disp(firstRow);'],
    explain: 'A(è¡Œ, åˆ—) è®¿é—®å•ä¸ªå…ƒç´ ï¼Œå†’å· : è¡¨ç¤º"æ‰€æœ‰"ã€‚A(2,3)=6ï¼ŒA(1,:)=[1 2 3]ã€‚æ³¨æ„ MATLAB ç´¢å¼•ä» 1 å¼€å§‹ã€‚',
    shuffled: null
  },
  {
    task: 'ä½¿ç”¨ switch-case åˆ¤æ–­æˆç»©ç­‰çº§ (A/B/C/D)',
    lines: ["grade = 'B';", 'switch grade', "    case 'A'", "        disp('ä¼˜ç§€');", "    case 'B'", "        disp('è‰¯å¥½');", '    otherwise', "        disp('ç»§ç»­åŠªåŠ›');", 'end'],
    explain: 'switch æ ¹æ®å˜é‡å€¼åŒ¹é… case åˆ†æ”¯ã€‚otherwise å¤„ç†æ‰€æœ‰æœªåŒ¹é…çš„æƒ…å†µï¼Œç±»ä¼¼ C è¯­è¨€çš„ defaultã€‚æ³¨æ„æ¯ä¸ª case ä¸éœ€è¦ breakã€‚',
    shuffled: null
  },
  {
    task: 'åˆ›å»ºä¸¤ä¸ªå­å›¾ï¼šå·¦è¾¹ç”» sin(x)ï¼Œå³è¾¹ç”» cos(x)',
    lines: ['x = linspace(0, 2*pi, 100);', 'subplot(1,2,1);', 'plot(x, sin(x));', "title('sin(x)');", 'subplot(1,2,2);', 'plot(x, cos(x));', "title('cos(x)');"],
    explain: 'subplot(è¡Œæ•°, åˆ—æ•°, ä½ç½®) åœ¨ä¸€ä¸ªçª—å£åˆ›å»ºå¤šä¸ªå­å›¾ã€‚subplot(1,2,1) è¡¨ç¤º1è¡Œ2åˆ—çš„ç¬¬1ä¸ªä½ç½®ã€‚æ¯ä¸ªå­å›¾åç´§è·Ÿå®ƒçš„ plot å’Œ titleã€‚',
    shuffled: null
  },
  {
    task: 'ä½¿ç”¨ try-catch å®‰å…¨åœ°è®¡ç®—çŸ©é˜µçš„é€†',
    lines: ['A = [1 2; 3 4];', 'try', '    B = inv(A);', '    disp(B);', 'catch ME', "    disp('çŸ©é˜µä¸å¯é€†');", '    disp(ME.message);', 'end'],
    explain: 'try-catch ç”¨äºå¼‚å¸¸å¤„ç†ã€‚try å—ä¸­çš„ä»£ç å¦‚æœå‡ºé”™ï¼Œç¨‹åºä¸ä¼šå´©æºƒè€Œæ˜¯è·³è½¬åˆ° catch å—ã€‚ME æ˜¯ MException å¯¹è±¡ï¼ŒåŒ…å«é”™è¯¯ä¿¡æ¯ã€‚',
    shuffled: null
  },
];

function initCodeBuilder() {
  const screen = document.getElementById('gameCodeBuilder');
  const challenges = shuffle([...codeBuilderData]).slice(0, 4);
  let currentQ = 0, score = 0;

  function renderCB() {
    const ch = challenges[currentQ];
    const shuffledLines = ch.shuffled || shuffle([...ch.lines]);
    ch.shuffled = shuffledLines;
    screen.innerHTML = makeGameHeader('ä»£ç æ‹¼è£…', 'gameCodeBuilder',
      `<span class="game-score">å¾—åˆ†: ${score}</span><span class="game-timer">${currentQ+1}/${challenges.length}</span>`
    ) + `<div class="game-body">
      <div class="codebuilder-wrap">
        <div class="cb-task"><div class="cb-task-label">â–¸ ä»»åŠ¡æè¿°</div><div class="cb-task-desc">${ch.task}</div></div>
        <div style="display:flex;gap:1.5rem;width:100%;flex-wrap:wrap">
          <div style="flex:1;min-width:280px">
            <div style="font-size:.7rem;color:var(--green);font-family:Orbitron;letter-spacing:.1em;margin-bottom:.5rem">â–¾ æ‹¼è£…åŒºï¼ˆæŒ‰æ­£ç¡®é¡ºåºæ’åˆ—ï¼‰</div>
            <div class="cb-dropzone" id="cbDrop"></div>
          </div>
          <div style="flex:1;min-width:220px">
            <div style="font-size:.7rem;color:var(--text2);font-family:Orbitron;letter-spacing:.1em;margin-bottom:.5rem">â–¾ ä»£ç å—ï¼ˆç‚¹å‡»ç§»åŠ¨ï¼‰</div>
            <div class="cb-source" id="cbSource"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="game-footer">
      <button class="btn btn-sm btn-cyan" onclick="checkCodeBuilder()">æäº¤éªŒè¯</button>
      <button class="btn btn-sm" onclick="resetCodeBuilder()">é‡ç½®</button>
    </div>`;

    const source = document.getElementById('cbSource');
    const drop = document.getElementById('cbDrop');

    shuffledLines.forEach((line, i) => {
      const block = createDraggableBlock(line, i);
      source.appendChild(block);
    });

    setupDropZone(drop, source);
    showScreen('gameCodeBuilder');
  }

  function createDraggableBlock(text, idx) {
    const block = document.createElement('div');
    block.className = 'cb-block';
    block.draggable = true;
    block.textContent = text;
    block.dataset.idx = idx;
    block.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', idx);
      block.classList.add('dragging');
    });
    block.addEventListener('dragend', () => block.classList.remove('dragging'));
    block.addEventListener('click', () => {
      const drop = document.getElementById('cbDrop');
      const source = document.getElementById('cbSource');
      if (block.parentElement === source) {
        drop.appendChild(block);
      } else {
        source.appendChild(block);
      }
      AudioEngine.play('click');
    });
    return block;
  }

  function setupDropZone(drop, source) {
    drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('over'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('over'));
    drop.addEventListener('drop', e => {
      e.preventDefault();
      drop.classList.remove('over');
      const idx = e.dataTransfer.getData('text/plain');
      const block = document.querySelector(`.cb-block[data-idx="${idx}"]`);
      if (block) { drop.appendChild(block); AudioEngine.play('click'); }
    });
  }

  window.checkCodeBuilder = () => {
    const drop = document.getElementById('cbDrop');
    const blocks = drop.querySelectorAll('.cb-block');
    const ch = challenges[currentQ];
    const userOrder = Array.from(blocks).map(b => b.textContent);
    let correct = true;
    blocks.forEach((b, i) => {
      if (b.textContent === ch.lines[i]) {
        b.classList.add('correct');
      } else {
        b.classList.add('wrong');
        correct = false;
      }
    });
    if (userOrder.length !== ch.lines.length) correct = false;
    if (correct) {
      AudioEngine.play('correct');
      score += 25;
      spawnParticles(window.innerWidth/2, window.innerHeight/2, '#00FF88', 20);
    } else {
      AudioEngine.play('wrong');
    }
    // Show correct order + explanation, then wait for user click
    const wrap = screen.querySelector('.codebuilder-wrap');
    if (!correct) {
      const correctBox = document.createElement('div');
      correctBox.style.cssText = 'width:100%;margin-top:1rem;padding:1rem;background:#00ff8808;border:1px solid var(--green);border-radius:8px';
      correctBox.innerHTML = `<div style="font-size:.7rem;color:var(--green);font-family:Orbitron;letter-spacing:.1em;margin-bottom:.5rem">â–¾ æ­£ç¡®é¡ºåº</div>` +
        ch.lines.map((l,i) => `<div style="font-family:'Fira Code';font-size:.8rem;color:var(--text);padding:.3rem .5rem;background:var(--bg2);border-radius:4px;margin-bottom:3px"><span style="color:var(--green);margin-right:.5rem">${i+1}.</span>${escHtml(l)}</div>`).join('');
      wrap.appendChild(correctBox);
    }
    const explainBox = document.createElement('div');
    explainBox.style.cssText = 'width:100%;margin-top:.8rem;padding:1rem;background:#ff660015;border-left:3px solid var(--orange);border-radius:0 8px 8px 0;font-size:.8rem;color:var(--text);line-height:1.6';
    explainBox.textContent = 'ğŸ’¡ ' + ch.explain;
    wrap.appendChild(explainBox);
    // Replace footer with "next" button
    const footer = screen.querySelector('.game-footer');
    const isLast = currentQ + 1 >= challenges.length;
    footer.innerHTML = `<button class="btn btn-sm btn-cyan" id="cbNext">${isLast ? 'æŸ¥çœ‹æˆç»©' : 'ä¸‹ä¸€é¢˜ â–¸'}</button>`;
    document.getElementById('cbNext').addEventListener('click', () => {
      AudioEngine.play('click');
      currentQ++;
      if (currentQ < challenges.length) {
        renderCB();
      } else {
        showResult('codebuilder', score, challenges.length * 25);
      }
    });
  };

  window.resetCodeBuilder = () => {
    const ch = challenges[currentQ];
    ch.shuffled = shuffle([...ch.lines]);
    renderCB();
  };

  renderCB();
}

// ===================== MODE 3: BUG HUNTER =====================
const bugHunterData = [
  {
    desc: 'æ­¤ä»£ç å°è¯•è®¡ç®—å‘é‡å…ƒç´ çš„å¹³å‡å€¼ï¼Œä½†æœ‰bugã€‚æ‰¾å‡ºæœ‰é”™è¯¯çš„è¡Œï¼',
    code: ['v = [3, 7, 1, 9, 4];', 'total = 0;', 'for i = 0:length(v)', '    total = total + v(i);', 'end', 'avg = total / length(v);', 'disp(avg);'],
    bugs: [2, 3],
    explain: 'MATLAB ç´¢å¼•ä» 1 å¼€å§‹ï¼åº”ä¸º i = 1:length(v)ï¼Œå¯¹åº” v(i) æ‰ä¸ä¼šè¶Šç•Œã€‚'
  },
  {
    desc: 'æ­¤ä»£ç æƒ³ç»˜åˆ¶ cos æ›²çº¿ï¼Œä½†è¿è¡Œä¼šæŠ¥é”™ã€‚æ‰¾å‡ºbugï¼',
    code: ['x = linspace(0, 2*pi, 50);', 'y = cos[x];', 'plot(x, y)', 'title("Cosine")'],
    bugs: [1],
    explain: 'å‡½æ•°è°ƒç”¨ç”¨åœ†æ‹¬å· cos(x)ï¼Œä¸æ˜¯æ–¹æ‹¬å· cos[x]ã€‚'
  },
  {
    desc: 'è¿™æ®µä»£ç æƒ³å®ç°çŸ©é˜µä¹˜æ³•ï¼Œä½†ç»“æœä¸å¯¹ã€‚æ‰¾bugï¼',
    code: ['A = [1 2; 3 4];', 'B = [5 6; 7 8];', 'C = A .* B;', 'disp(C);'],
    bugs: [2],
    explain: '.* æ˜¯é€å…ƒç´ ä¹˜æ³•ï¼ŒçŸ©é˜µä¹˜æ³•åº”ä½¿ç”¨ A * Bã€‚'
  },
  {
    desc: 'æ­¤ä»£ç æƒ³æŠŠçŸ©é˜µ A è½¬ç½®åå­˜å…¥ Bï¼Œä½†å†™æ³•æœ‰è¯¯ã€‚',
    code: ['A = [1 2 3; 4 5 6];', 'B = transpose[A];', 'disp(B);'],
    bugs: [1],
    explain: "å‡½æ•°ç”¨åœ†æ‹¬å·è°ƒç”¨ï¼šB = transpose(A); æˆ– B = A';"
  },
  {
    desc: 'æ­¤ä»£ç å°è¯•ç”¨ if-else åˆ¤æ–­å¥‡å¶ï¼Œä½†é€»è¾‘æœ‰è¯¯ã€‚',
    code: ['n = 7;', 'if mod(n, 2) = 0', "    disp('å¶æ•°');", 'else', "    disp('å¥‡æ•°');", 'end'],
    bugs: [1],
    explain: 'æ¯”è¾ƒåº”ä½¿ç”¨ == è€Œé =ã€‚æ­£ç¡®ï¼šif mod(n, 2) == 0'
  },
  {
    desc: 'æ­¤ä»£ç æƒ³ç”Ÿæˆ 3x3 å•ä½çŸ©é˜µå¹¶å–å¯¹è§’çº¿ï¼Œä½†æœ‰é”™è¯¯ã€‚',
    code: ['I = eye(3, 1);', 'd = diag(I);', 'disp(d);'],
    bugs: [0],
    explain: 'eye(3,1) ç”Ÿæˆ 3x1 çŸ©é˜µï¼Œä¸æ˜¯å•ä½çŸ©é˜µã€‚åº”ä¸º eye(3) æˆ– eye(3,3)ã€‚'
  },
  {
    desc: 'æ­¤ä»£ç æƒ³å°†å­—ç¬¦ä¸²æ‹¼æ¥å¹¶æ˜¾ç¤ºï¼Œä½†å†™æ³•æœ‰é—®é¢˜ã€‚',
    code: ['name = "MATLAB";', 'ver = 2024;', 'msg = name + " R" + ver;', 'disp(msg);'],
    bugs: [2],
    explain: 'æ•°å­—ä¸èƒ½ç›´æ¥ä¸å­—ç¬¦ä¸²ç”¨ + æ‹¼æ¥ã€‚åº”ä½¿ç”¨ num2str(ver) æˆ– string(ver)ã€‚'
  },
  {
    desc: 'æ­¤ä»£ç æƒ³åˆ›å»ºå…ƒèƒæ•°ç»„å¹¶è®¿é—®å†…å®¹ï¼Œä½†è¯­æ³•æœ‰è¯¯ã€‚',
    code: ["C = {1, 'hello', [1 2 3]};", 'x = C(3);', 'disp(x(2));'],
    bugs: [1, 2],
    explain: 'C(3) è¿”å›å…ƒèƒï¼Œåº”ç”¨ C{3} è·å–å†…å®¹ã€‚x(2) å‰éœ€å…ˆæ­£ç¡®æå–æ•°ç»„ã€‚'
  },
  {
    desc: 'æ­¤ä»£ç æƒ³ç”Ÿæˆä¸€ä¸ªè¡Œå‘é‡å¹¶çºµå‘æ‹¼æ¥ï¼Œä½†æ“ä½œæœ‰è¯¯ã€‚',
    code: ['a = [1 2 3];', 'b = [4 5 6];', 'c = [a; b;]', 'd = c(:, 4);', 'disp(d);'],
    bugs: [3],
    explain: 'c åªæœ‰3åˆ—ï¼Œc(:,4) è¶…å‡ºç´¢å¼•èŒƒå›´ã€‚åº”ä¸º c(:,3) æˆ–æ£€æŸ¥å°ºå¯¸ã€‚'
  },
];

function initBugHunter() {
  const screen = document.getElementById('gameBugHunter');
  const challenges = shuffle([...bugHunterData]).slice(0, 5);
  let currentQ = 0, score = 0;

  function renderBH() {
    const ch = challenges[currentQ];
    const selected = new Set();
    screen.innerHTML = makeGameHeader('BugçŒäºº', 'gameBugHunter',
      `<span class="game-score">å¾—åˆ†: ${score}</span><span class="game-timer">${currentQ+1}/${challenges.length}</span>`
    ) + `<div class="game-body">
      <div class="bughunter-wrap">
        <div class="bh-desc">ğŸ› ${ch.desc}</div>
        <div class="bh-editor">
          <div class="bh-editor-header">
            <span class="dot" style="background:#ff5f57"></span>
            <span class="dot" style="background:#ffbd2e"></span>
            <span class="dot" style="background:#28ca41"></span>
            <span style="margin-left:.5rem">buggy_code.m</span>
          </div>
          <div class="bh-lines" id="bhLines"></div>
        </div>
      </div>
    </div>
    <div class="game-footer">
      <button class="btn btn-sm btn-cyan" id="bhSubmit">æäº¤ï¼ˆç‚¹å‡»é€‰ä¸­æœ‰bugçš„è¡Œï¼‰</button>
    </div>`;

    const linesEl = document.getElementById('bhLines');
    ch.code.forEach((line, i) => {
      const lineEl = document.createElement('div');
      lineEl.className = 'bh-line';
      lineEl.innerHTML = `<span class="bh-linenum">${i+1}</span><span class="bh-code">${escHtml(line)}</span>`;
      lineEl.addEventListener('click', () => {
        AudioEngine.play('click');
        if (selected.has(i)) { selected.delete(i); lineEl.classList.remove('selected'); }
        else { selected.add(i); lineEl.classList.add('selected'); }
      });
      linesEl.appendChild(lineEl);
    });

    document.getElementById('bhSubmit').addEventListener('click', () => {
      const lines = linesEl.querySelectorAll('.bh-line');
      let correct = true;
      ch.bugs.forEach(b => {
        if (!selected.has(b)) { correct = false; lines[b].classList.add('missed-bug'); }
        else { lines[b].classList.add('correct-bug'); lines[b].classList.remove('selected'); }
      });
      selected.forEach(s => {
        if (!ch.bugs.includes(s)) { correct = false; }
      });
      if (correct) {
        AudioEngine.play('correct');
        score += 20;
        spawnParticles(window.innerWidth/2, window.innerHeight/2, '#00FF88', 15);
      } else {
        AudioEngine.play('wrong');
        ch.bugs.forEach(b => lines[b].classList.add('correct-bug'));
      }
      // Disable further clicks on lines
      linesEl.querySelectorAll('.bh-line').forEach(l => l.style.pointerEvents = 'none');
      // Show explanation
      const wrap = screen.querySelector('.bughunter-wrap');
      const exp = document.createElement('div');
      exp.style.cssText = 'margin-top:1rem;padding:1rem;background:#ff660015;border-left:3px solid var(--orange);border-radius:0 8px 8px 0;font-size:.8rem;color:var(--text);line-height:1.5';
      exp.textContent = 'ğŸ’¡ ' + ch.explain;
      wrap.appendChild(exp);
      // Replace footer with "next" button
      const footer = screen.querySelector('.game-footer');
      const isLast = currentQ + 1 >= challenges.length;
      footer.innerHTML = `<button class="btn btn-sm btn-cyan" id="bhNext">${isLast ? 'æŸ¥çœ‹æˆç»©' : 'ä¸‹ä¸€é¢˜ â–¸'}</button>`;
      document.getElementById('bhNext').addEventListener('click', () => {
        AudioEngine.play('click');
        currentQ++;
        if (currentQ < challenges.length) renderBH();
        else showResult('bughunter', score, challenges.length * 20);
      });
    });

    showScreen('gameBugHunter');
  }
  renderBH();
}

// ===================== MODE 4: MATRIX ARENA =====================
function initMatrix() {
  const screen = document.getElementById('gameMatrix');
  const challenges = generateMatrixChallenges();
  let currentQ = 0, score = 0;

  function renderMatrix() {
    const ch = challenges[currentQ];
    screen.innerHTML = makeGameHeader('çŸ©é˜µç«æŠ€åœº', 'gameMatrix',
      `<span class="game-score">å¾—åˆ†: ${score}</span><span class="game-timer">${currentQ+1}/${challenges.length}</span>`
    ) + `<div class="game-body">
      <div class="matrix-wrap">
        <div class="matrix-question">${ch.question}</div>
        <div class="matrix-display" id="matDisplay"></div>
        <div id="matInputArea"></div>
      </div>
    </div>
    <div class="game-footer">
      <button class="btn btn-sm btn-cyan" id="matSubmit">æäº¤ç­”æ¡ˆ</button>
    </div>`;

    const display = document.getElementById('matDisplay');
    const inputArea = document.getElementById('matInputArea');

    if (ch.matA) display.appendChild(renderMatrixGrid(ch.matA, 'var(--cyan)'));
    if (ch.op) { const op = document.createElement('span'); op.className='matrix-op'; op.textContent=ch.op; display.appendChild(op); }
    if (ch.matB) display.appendChild(renderMatrixGrid(ch.matB, 'var(--purple)'));
    if (ch.matA || ch.matB) { const eq = document.createElement('span'); eq.className='matrix-eq'; eq.textContent='='; display.appendChild(eq); }

    if (ch.answerType === 'matrix') {
      const rows = ch.answer.length, cols = ch.answer[0].length;
      const grid = document.createElement('div');
      grid.className = 'matrix-input-grid';
      grid.style.gridTemplateColumns = `repeat(${cols}, 48px)`;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const inp = document.createElement('input');
          inp.className = 'matrix-input-cell';
          inp.type = 'number';
          inp.dataset.r = r;
          inp.dataset.c = c;
          grid.appendChild(inp);
        }
      }
      inputArea.appendChild(grid);
    } else {
      const inp = document.createElement('input');
      inp.className = 'matrix-input-cell';
      inp.type = 'number';
      inp.id = 'matScalarInput';
      inp.style.cssText = 'width:80px;height:50px;font-size:1.2rem;margin:0 auto;display:block';
      inputArea.appendChild(inp);
    }

    document.getElementById('matSubmit').addEventListener('click', () => {
      let correct = true;
      if (ch.answerType === 'matrix') {
        const inputs = inputArea.querySelectorAll('.matrix-input-cell');
        inputs.forEach(inp => {
          const r = +inp.dataset.r, c = +inp.dataset.c;
          if (+inp.value !== ch.answer[r][c]) { correct = false; inp.style.borderColor = 'var(--red)'; }
          else { inp.style.borderColor = 'var(--green)'; }
          inp.disabled = true;
        });
      } else {
        const inp = document.getElementById('matScalarInput');
        const v = +inp.value;
        if (v !== ch.answer) { correct = false; inp.style.borderColor = 'var(--red)'; }
        else { inp.style.borderColor = 'var(--green)'; }
        inp.disabled = true;
      }
      if (correct) { AudioEngine.play('correct'); score += 20; spawnParticles(window.innerWidth/2, window.innerHeight/2, '#00FF88'); }
      else AudioEngine.play('wrong');
      // Show correct answer if wrong
      const wrap = screen.querySelector('.matrix-wrap');
      if (!correct) {
        const ansBox = document.createElement('div');
        ansBox.style.cssText = 'margin-top:.8rem;padding:.8rem;background:#00ff8808;border:1px solid var(--green);border-radius:6px;font-family:"Fira Code";font-size:.85rem;color:var(--green);text-align:center';
        if (ch.answerType === 'matrix') {
          ansBox.textContent = 'æ­£ç¡®ç­”æ¡ˆ: [' + ch.answer.map(r => r.join(' ')).join('; ') + ']';
        } else {
          ansBox.textContent = 'æ­£ç¡®ç­”æ¡ˆ: ' + ch.answer;
        }
        wrap.appendChild(ansBox);
      }
      // Show explanation
      if (ch.explain) {
        const exp = document.createElement('div');
        exp.style.cssText = 'margin-top:.5rem;padding:.8rem;background:#ff660015;border-left:3px solid var(--orange);border-radius:0 8px 8px 0;font-size:.8rem;color:var(--text);line-height:1.5';
        exp.textContent = 'ğŸ’¡ ' + ch.explain;
        wrap.appendChild(exp);
      }
      // Replace footer with "next" button
      const footer = screen.querySelector('.game-footer');
      const isLast = currentQ + 1 >= challenges.length;
      footer.innerHTML = `<button class="btn btn-sm btn-cyan" id="matNext">${isLast ? 'æŸ¥çœ‹æˆç»©' : 'ä¸‹ä¸€é¢˜ â–¸'}</button>`;
      document.getElementById('matNext').addEventListener('click', () => {
        AudioEngine.play('click');
        currentQ++;
        if (currentQ < challenges.length) renderMatrix();
        else showResult('matrix', score, challenges.length * 20);
      });
    });

    showScreen('gameMatrix');
  }

  function renderMatrixGrid(mat, color) {
    const rows = mat.length, cols = mat[0].length;
    const grid = document.createElement('div');
    grid.className = 'matrix-grid';
    grid.style.gridTemplateColumns = `repeat(${cols}, 48px)`;
    mat.forEach(row => row.forEach(v => {
      const cell = document.createElement('div');
      cell.className = 'matrix-cell';
      cell.style.color = color;
      cell.textContent = v;
      grid.appendChild(cell);
    }));
    return grid;
  }

  renderMatrix();
}

function generateMatrixChallenges() {
  const ch = [];
  const a1 = [[1,2,3],[4,5,6]];
  ch.push({ question: "æ±‚çŸ©é˜µ A çš„è½¬ç½® A'", matA: a1, op: null, matB: null, answerType: 'matrix', answer: [[1,4],[2,5],[3,6]], explain: "è½¬ç½®å°†è¡Œå˜åˆ—ï¼šåŸç¬¬1è¡Œ [1,2,3] å˜æˆç¬¬1åˆ— [1;2;3]ï¼ŒåŸç¬¬2è¡Œ [4,5,6] å˜æˆç¬¬2åˆ— [4;5;6]ã€‚" });
  const a2 = [[1,2],[3,4]], b2 = [[5,6],[7,8]];
  ch.push({ question: 'è®¡ç®— A + B', matA: a2, op: '+', matB: b2, answerType: 'matrix', answer: [[6,8],[10,12]], explain: "çŸ©é˜µåŠ æ³•æ˜¯å¯¹åº”ä½ç½®å…ƒç´ ç›¸åŠ ï¼š1+5=6, 2+6=8, 3+7=10, 4+8=12ã€‚" });
  const a3 = [[1,2],[3,4]], b3 = [[2,0],[1,3]];
  ch.push({ question: 'è®¡ç®—çŸ©é˜µä¹˜æ³• A * B', matA: a3, op: 'Ã—', matB: b3, answerType: 'matrix', answer: [[4,6],[10,12]], explain: "çŸ©é˜µä¹˜æ³•ï¼šC(i,j) = ç¬¬iè¡Œ Â· ç¬¬jåˆ—ã€‚å¦‚ C(1,1)=1Ã—2+2Ã—1=4, C(1,2)=1Ã—0+2Ã—3=6ã€‚" });
  const a4 = [[2,3],[4,1]], b4 = [[1,2],[3,5]];
  ch.push({ question: 'è®¡ç®—é€å…ƒç´ ä¹˜æ³• A .* B', matA: a4, op: '.*', matB: b4, answerType: 'matrix', answer: [[2,6],[12,5]], explain: ".* æ˜¯é€å…ƒç´ ç›¸ä¹˜ï¼ˆä¸æ˜¯çŸ©é˜µä¹˜æ³•ï¼‰ï¼š2Ã—1=2, 3Ã—2=6, 4Ã—3=12, 1Ã—5=5ã€‚" });
  const a5 = [[3,1],[2,4]];
  ch.push({ question: 'è®¡ç®— det(A) è¡Œåˆ—å¼çš„å€¼', matA: a5, op: null, matB: null, answerType: 'scalar', answer: 10, explain: "2Ã—2çŸ©é˜µè¡Œåˆ—å¼ = a*d - b*c = 3Ã—4 - 1Ã—2 = 10ã€‚" });
  const a6 = [[10,20,30],[40,50,60],[70,80,90]];
  ch.push({ question: 'A(2,3) çš„å€¼æ˜¯ï¼Ÿï¼ˆMATLABä»1å¼€å§‹ç´¢å¼•ï¼‰', matA: a6, op: null, matB: null, answerType: 'scalar', answer: 60, explain: "A(2,3) = ç¬¬2è¡Œç¬¬3åˆ— = 60ã€‚MATLAB ç´¢å¼•ä»1å¼€å§‹ï¼Œä¸åƒ C/Python ä»0å¼€å§‹ã€‚" });
  const a7 = [[1,2],[3,4]];
  ch.push({ question: 'è®¡ç®— 2 * A', matA: a7, op: null, matB: null, answerType: 'matrix', answer: [[2,4],[6,8]], explain: "æ ‡é‡ä¹˜çŸ©é˜µï¼šæ¯ä¸ªå…ƒç´ éƒ½ä¹˜ä»¥2ã€‚1â†’2, 2â†’4, 3â†’6, 4â†’8ã€‚" });
  const a8 = [[5,3],[1,7]], b8 = [[2,1],[4,3]];
  ch.push({ question: 'è®¡ç®— A - B', matA: a8, op: '-', matB: b8, answerType: 'matrix', answer: [[3,2],[-3,4]], explain: "çŸ©é˜µå‡æ³•æ˜¯å¯¹åº”ä½ç½®å…ƒç´ ç›¸å‡ï¼š5-2=3, 3-1=2, 1-4=-3, 7-3=4ã€‚" });
  return shuffle(ch).slice(0, 5);
}

// ===================== MODE 5: SPEED TYPING CONSOLE =====================
const terminalTasks = [
  // --- çŸ©é˜µåˆ›å»º ---
  { prompt: 'åˆ›å»ºä¸€ä¸ª 3x3 çš„å…¨é›¶çŸ©é˜µ', answer: 'zeros(3,3)', alt: ['zeros(3, 3)', 'zeros(3)'], explain: 'zeros(m,n) åˆ›å»º mÃ—n çš„å…¨é›¶çŸ©é˜µï¼Œzeros(n) åˆ›å»º nÃ—n æ–¹é˜µ' },
  { prompt: 'åˆ›å»º 4 é˜¶å•ä½çŸ©é˜µ', answer: 'eye(4)', alt: ['eye(4,4)', 'eye(4, 4)'], explain: 'eye(n) ç”Ÿæˆ n é˜¶å•ä½çŸ©é˜µï¼ˆå¯¹è§’çº¿ä¸º1ï¼‰' },
  { prompt: 'åˆ›å»ºä¸€ä¸ª 2x5 çš„å…¨1çŸ©é˜µ', answer: 'ones(2,5)', alt: ['ones(2, 5)'], explain: 'ones(m,n) åˆ›å»º mÃ—n çš„å…¨1çŸ©é˜µ' },
  { prompt: 'ç”Ÿæˆ 2x5 çš„å‡åŒ€éšæœºçŸ©é˜µ', answer: 'rand(2,5)', alt: ['rand(2, 5)'], explain: 'rand(m,n) ç”Ÿæˆ [0,1) åŒºé—´çš„å‡åŒ€åˆ†å¸ƒéšæœºæ•°' },
  { prompt: 'ç”Ÿæˆ 3x3 çš„æ ‡å‡†æ­£æ€åˆ†å¸ƒéšæœºçŸ©é˜µ', answer: 'randn(3,3)', alt: ['randn(3, 3)', 'randn(3)'], explain: 'randn(m,n) ç”Ÿæˆå‡å€¼0ã€æ ‡å‡†å·®1çš„æ­£æ€åˆ†å¸ƒéšæœºæ•°' },
  { prompt: 'åˆ›å»ºä¸€ä¸ª 3 é˜¶é­”æ–¹é˜µ', answer: 'magic(3)', alt: [], explain: 'magic(n) åˆ›å»º n é˜¶é­”æ–¹é˜µï¼Œæ¯è¡Œæ¯åˆ—åŠå¯¹è§’çº¿å…ƒç´ ä¹‹å’Œç›¸ç­‰' },
  { prompt: 'åˆ›å»ºä¸€ä¸ª 4x4 çš„å¯¹è§’çŸ©é˜µï¼Œå¯¹è§’çº¿ä¸º [1 2 3 4]', answer: 'diag([1 2 3 4])', alt: ['diag([1,2,3,4])'], explain: 'diag(v) ç”¨å‘é‡ v åˆ›å»ºå¯¹è§’çŸ©é˜µï¼Œdiag(A) æå–çŸ©é˜µå¯¹è§’çº¿' },
  { prompt: 'ç”Ÿæˆä» 1 åˆ° 10 çš„è¡Œå‘é‡', answer: '1:10', alt: ['1:1:10'], explain: 'èµ·å§‹:æ­¥é•¿:ç»ˆæ­¢ï¼Œé»˜è®¤æ­¥é•¿ä¸º1' },
  { prompt: 'ç”Ÿæˆä» 0 åˆ° 1 æ­¥é•¿ä¸º 0.2 çš„å‘é‡', answer: '0:0.2:1', alt: [], explain: 'èµ·å§‹:æ­¥é•¿:ç»ˆæ­¢ï¼Œç”Ÿæˆ [0 0.2 0.4 0.6 0.8 1]' },

  // --- å‘é‡/æ•°ç»„ç”Ÿæˆ ---
  { prompt: 'ç”Ÿæˆ 1 åˆ° 100 çš„ç­‰è·50ä¸ªç‚¹', answer: 'linspace(1,100,50)', alt: ['linspace(1, 100, 50)'], explain: 'linspace(èµ·å§‹, ç»ˆæ­¢, ç‚¹æ•°)ï¼Œå«ä¸¤ç«¯' },
  { prompt: 'ç”Ÿæˆ 10^1 åˆ° 10^5 çš„5ä¸ªå¯¹æ•°ç­‰è·ç‚¹', answer: 'logspace(1,5,5)', alt: ['logspace(1, 5, 5)'], explain: 'logspace(a,b,n) ç”Ÿæˆ 10^a åˆ° 10^b çš„ n ä¸ªå¯¹æ•°ç­‰è·ç‚¹' },

  // --- çŸ©é˜µè¿ç®— ---
  { prompt: 'è®¡ç®—çŸ©é˜µ A çš„è¡Œåˆ—å¼', answer: 'det(A)', alt: [], explain: 'det() è®¡ç®—æ–¹é˜µçš„è¡Œåˆ—å¼å€¼' },
  { prompt: 'è®¡ç®—çŸ©é˜µ A çš„é€†', answer: 'inv(A)', alt: [], explain: 'inv() æ±‚é€†çŸ©é˜µï¼Œè¦æ±‚çŸ©é˜µå¯é€†(éå¥‡å¼‚)' },
  { prompt: 'æ±‚çŸ©é˜µ A çš„ç‰¹å¾å€¼', answer: 'eig(A)', alt: [], explain: 'eig() è¿”å›ç‰¹å¾å€¼ï¼Œ[V,D]=eig(A) è¿˜å¯è·å–ç‰¹å¾å‘é‡' },
  { prompt: 'æ±‚çŸ©é˜µ A çš„ç§©', answer: 'rank(A)', alt: [], explain: 'rank() è¿”å›çŸ©é˜µçš„ç§©ï¼ˆçº¿æ€§æ— å…³è¡Œ/åˆ—çš„æœ€å¤§æ•°é‡ï¼‰' },
  { prompt: 'æ±‚çŸ©é˜µ A çš„è¿¹ï¼ˆå¯¹è§’çº¿å…ƒç´ ä¹‹å’Œï¼‰', answer: 'trace(A)', alt: [], explain: 'trace() è¿”å›æ–¹é˜µä¸»å¯¹è§’çº¿å…ƒç´ ä¹‹å’Œ' },
  { prompt: 'å¯¹çŸ©é˜µ A è¿›è¡Œè½¬ç½®', answer: "A'", alt: ['transpose(A)', "A.'"], explain: "A' æ˜¯å…±è½­è½¬ç½®ï¼ŒA.' æ˜¯æ™®é€šè½¬ç½®ï¼Œå®æ•°çŸ©é˜µäºŒè€…ç›¸åŒ" },
  { prompt: 'è®¡ç®—çŸ©é˜µ A çš„èŒƒæ•°', answer: 'norm(A)', alt: [], explain: 'norm é»˜è®¤è®¡ç®—2-èŒƒæ•°ï¼ˆæœ€å¤§å¥‡å¼‚å€¼ï¼‰' },
  { prompt: 'å°†çŸ©é˜µ A é‡å¡‘ä¸º 3x4', answer: 'reshape(A,3,4)', alt: ['reshape(A, 3, 4)'], explain: 'reshape è¦æ±‚å…ƒç´ æ€»æ•°ä¸å˜' },
  { prompt: 'å°†çŸ©é˜µ A å·¦å³ç¿»è½¬', answer: 'fliplr(A)', alt: [], explain: 'fliplr å·¦å³ç¿»è½¬ï¼Œflipud ä¸Šä¸‹ç¿»è½¬' },
  { prompt: 'å°†çŸ©é˜µ A ä¸Šä¸‹ç¿»è½¬', answer: 'flipud(A)', alt: [], explain: 'flipud ä¸Šä¸‹ç¿»è½¬çŸ©é˜µå„è¡Œçš„é¡ºåº' },
  { prompt: 'å°†çŸ©é˜µ A é€†æ—¶é’ˆæ—‹è½¬ 90 åº¦', answer: 'rot90(A)', alt: ['rot90(A,1)'], explain: 'rot90(A,k) æ—‹è½¬ k ä¸ª 90 åº¦ï¼Œé»˜è®¤ k=1' },

  // --- ç»Ÿè®¡å‡½æ•° ---
  { prompt: 'å¯¹å‘é‡ v è¿›è¡Œæ’åº', answer: 'sort(v)', alt: [], explain: 'sort é»˜è®¤å‡åºæ’åˆ—' },
  { prompt: 'å¯¹å‘é‡ v è¿›è¡Œé™åºæ’åº', answer: "sort(v,'descend')", alt: ["sort(v, 'descend')"], explain: "sort(v,'descend') é™åºæ’åˆ—" },
  { prompt: 'æ±‚å‘é‡ v ä¸­çš„æœ€å¤§å€¼', answer: 'max(v)', alt: [], explain: 'max() è¿”å›æœ€å¤§å€¼ï¼Œ[m,i]=max(v) è¿˜å¯è·å–ç´¢å¼•' },
  { prompt: 'æ±‚å‘é‡ v ä¸­çš„æœ€å°å€¼', answer: 'min(v)', alt: [], explain: 'min() è¿”å›æœ€å°å€¼' },
  { prompt: 'è®¡ç®—å‘é‡ v çš„å¹³å‡å€¼', answer: 'mean(v)', alt: [], explain: 'mean() è®¡ç®—ç®—æœ¯å¹³å‡å€¼' },
  { prompt: 'è®¡ç®—å‘é‡ v çš„ä¸­ä½æ•°', answer: 'median(v)', alt: [], explain: 'median() è¿”å›ä¸­é—´å€¼' },
  { prompt: 'è®¡ç®—å‘é‡ v çš„æ ‡å‡†å·®', answer: 'std(v)', alt: [], explain: 'std() é»˜è®¤è®¡ç®—æ ·æœ¬æ ‡å‡†å·®ï¼ˆé™¤ä»¥ n-1ï¼‰' },
  { prompt: 'è®¡ç®—å‘é‡ v çš„æ–¹å·®', answer: 'var(v)', alt: [], explain: 'var() é»˜è®¤è®¡ç®—æ ·æœ¬æ–¹å·®' },
  { prompt: 'è®¡ç®—å‘é‡ v çš„å…ƒç´ æ€»å’Œ', answer: 'sum(v)', alt: [], explain: 'sum() æ±‚å’Œï¼Œå¯¹çŸ©é˜µé»˜è®¤æŒ‰åˆ—æ±‚å’Œ' },
  { prompt: 'è®¡ç®—å‘é‡ v çš„å…ƒç´ ç´¯ç§¯å’Œ', answer: 'cumsum(v)', alt: [], explain: 'cumsum() è¿”å›ç´¯ç§¯å’Œå‘é‡' },
  { prompt: 'è®¡ç®—å‘é‡ v çš„å…ƒç´ ä¹˜ç§¯', answer: 'prod(v)', alt: [], explain: 'prod() è®¡ç®—æ‰€æœ‰å…ƒç´ çš„ä¹˜ç§¯' },

  // --- æ•°å­¦å‡½æ•° ---
  { prompt: 'è®¡ç®— x çš„ç»å¯¹å€¼', answer: 'abs(x)', alt: [], explain: 'abs() è¿”å›ç»å¯¹å€¼ï¼Œå¯¹å¤æ•°è¿”å›æ¨¡' },
  { prompt: 'è®¡ç®— x çš„å¹³æ–¹æ ¹', answer: 'sqrt(x)', alt: [], explain: 'sqrt() ç­‰ä»·äº x.^0.5' },
  { prompt: 'è®¡ç®— e çš„ x æ¬¡å¹‚', answer: 'exp(x)', alt: [], explain: 'exp(x) = e^x' },
  { prompt: 'è®¡ç®— x çš„è‡ªç„¶å¯¹æ•°', answer: 'log(x)', alt: [], explain: 'log() æ˜¯è‡ªç„¶å¯¹æ•° ln(x)ï¼Œä¸æ˜¯ log10' },
  { prompt: 'è®¡ç®— x çš„ä»¥ 10 ä¸ºåº•çš„å¯¹æ•°', answer: 'log10(x)', alt: [], explain: 'log10() è®¡ç®—å¸¸ç”¨å¯¹æ•°' },
  { prompt: 'è®¡ç®— x çš„ä»¥ 2 ä¸ºåº•çš„å¯¹æ•°', answer: 'log2(x)', alt: [], explain: 'log2() åœ¨äºŒè¿›åˆ¶è®¡ç®—ä¸­å¸¸ç”¨' },
  { prompt: 'å¯¹ x å‘ä¸‹å–æ•´', answer: 'floor(x)', alt: [], explain: 'floor() å‘è´Ÿæ— ç©·å–æ•´' },
  { prompt: 'å¯¹ x å‘ä¸Šå–æ•´', answer: 'ceil(x)', alt: [], explain: 'ceil() å‘æ­£æ— ç©·å–æ•´' },
  { prompt: 'å¯¹ x å››èˆäº”å…¥', answer: 'round(x)', alt: [], explain: 'round() å››èˆäº”å…¥åˆ°æœ€è¿‘æ•´æ•°' },
  { prompt: 'è®¡ç®— x é™¤ä»¥ y çš„ä½™æ•°', answer: 'mod(x,y)', alt: ['mod(x, y)', 'rem(x,y)'], explain: 'mod(x,y) å–æ¨¡è¿ç®—ï¼Œrem(x,y) å–ä½™è¿ç®—' },
  { prompt: 'æ±‚ x çš„æ­£å¼¦å€¼', answer: 'sin(x)', alt: [], explain: 'sin() å‚æ•°å•ä½ä¸ºå¼§åº¦' },
  { prompt: 'æ±‚ x çš„ä½™å¼¦å€¼', answer: 'cos(x)', alt: [], explain: 'cos() å‚æ•°å•ä½ä¸ºå¼§åº¦' },
  { prompt: 'æ±‚ x çš„æ­£åˆ‡å€¼', answer: 'tan(x)', alt: [], explain: 'tan() å‚æ•°å•ä½ä¸ºå¼§åº¦' },
  { prompt: 'æ±‚ x çš„åæ­£å¼¦å€¼', answer: 'asin(x)', alt: [], explain: 'asin() è¿”å›å¼§åº¦å€¼ï¼Œx èŒƒå›´ [-1,1]' },
  { prompt: 'è®¡ç®—å‘é‡ x çš„å¿«é€Ÿå‚…é‡Œå¶å˜æ¢', answer: 'fft(x)', alt: [], explain: 'fft è®¡ç®—ç¦»æ•£å‚…é‡Œå¶å˜æ¢ï¼Œifft ä¸ºé€†å˜æ¢' },

  // --- çŸ©é˜µä¿¡æ¯ ---
  { prompt: 'è·å–çŸ©é˜µ A çš„å¤§å°', answer: 'size(A)', alt: [], explain: 'size è¿”å› [è¡Œæ•° åˆ—æ•°]ï¼Œsize(A,1) å•ç‹¬è·å–è¡Œæ•°' },
  { prompt: 'è·å–å‘é‡ v çš„é•¿åº¦', answer: 'length(v)', alt: [], explain: 'length() è¿”å›æœ€å¤§ç»´åº¦çš„é•¿åº¦' },
  { prompt: 'è·å–çŸ©é˜µ A çš„å…ƒç´ æ€»æ•°', answer: 'numel(A)', alt: [], explain: 'numel() = è¡Œæ•° Ã— åˆ—æ•°' },
  { prompt: 'åˆ¤æ–­å˜é‡ x æ˜¯å¦ä¸ºç©º', answer: 'isempty(x)', alt: [], explain: 'isempty() å¯¹ç©ºçŸ©é˜µ [] è¿”å› true' },
  { prompt: 'åˆ¤æ–­ x æ˜¯å¦ä¸º NaN', answer: 'isnan(x)', alt: [], explain: 'NaN ä¸ç­‰äºä»»ä½•å€¼åŒ…æ‹¬è‡ªèº«ï¼Œåªèƒ½ç”¨ isnan æ£€æµ‹' },
  { prompt: 'åˆ¤æ–­ x æ˜¯å¦ä¸ºæœ‰é™æ•°', answer: 'isfinite(x)', alt: [], explain: 'isfinite å¯¹ NaN å’Œ Inf è¿”å› false' },

  // --- ç»˜å›¾å‘½ä»¤ ---
  { prompt: 'æ‰“å¼€ä¸€ä¸ªæ–°çš„å›¾å½¢çª—å£', answer: 'figure', alt: ['figure;', 'figure()'], explain: 'figure åˆ›å»ºæ–°å›¾å½¢çª—å£ï¼Œåç»­ plot ä¼šç”»åœ¨æ­¤çª—å£' },
  { prompt: 'ä¸ºå½“å‰å›¾å½¢æ·»åŠ ç½‘æ ¼çº¿', answer: 'grid on', alt: ['grid on;'], explain: 'grid on/off æ§åˆ¶ç½‘æ ¼çº¿æ˜¾ç¤º' },
  { prompt: 'å…³é—­æ‰€æœ‰å›¾å½¢çª—å£', answer: 'close all', alt: ['close all;'], explain: 'close all å…³é—­æ‰€æœ‰ figure çª—å£' },
  { prompt: 'ä¿æŒå½“å‰å›¾å½¢ä»¥ä¾¿å åŠ ç»˜å›¾', answer: 'hold on', alt: ['hold on;'], explain: 'hold on åï¼Œæ–° plot ä¸ä¼šè¦†ç›–æ—§å›¾ï¼Œè€Œæ˜¯å åŠ ' },
  { prompt: 'å–æ¶ˆ hold çŠ¶æ€', answer: 'hold off', alt: ['hold off;'], explain: 'hold off åï¼Œæ–° plot ä¼šæ›¿æ¢æ—§å›¾' },
  { prompt: 'ä¸ºå›¾å½¢æ·»åŠ å›¾ä¾‹', answer: 'legend', alt: ['legend()'], explain: "legend('a','b') ä¸ºæ›²çº¿æ·»åŠ æ ‡ç­¾è¯´æ˜" },
  { prompt: 'è®¾ç½® x è½´çš„èŒƒå›´ä¸º 0 åˆ° 10', answer: 'xlim([0 10])', alt: ['xlim([0, 10])'], explain: 'xlim/ylim æ‰‹åŠ¨è®¾ç½®åæ ‡è½´èŒƒå›´' },
  { prompt: 'è®¾ç½® y è½´çš„èŒƒå›´ä¸º -1 åˆ° 1', answer: 'ylim([-1 1])', alt: ['ylim([-1, 1])'], explain: 'ylim([ymin ymax]) è®¾ç½® y è½´èŒƒå›´' },
  { prompt: 'ç»˜åˆ¶å‘é‡ x å’Œ y çš„çº¿å›¾', answer: 'plot(x,y)', alt: ['plot(x, y)'], explain: 'plot æ˜¯æœ€åŸºæœ¬çš„2Dç»˜å›¾å‘½ä»¤' },
  { prompt: 'ç»˜åˆ¶æ•°æ®çš„æŸ±çŠ¶å›¾', answer: 'bar(data)', alt: ['bar(data);'], explain: 'bar() ç»˜åˆ¶ç«–ç›´æŸ±çŠ¶å›¾ï¼Œbarh() ç»˜åˆ¶æ°´å¹³æŸ±çŠ¶å›¾' },
  { prompt: 'ç»˜åˆ¶æ•£ç‚¹å›¾', answer: 'scatter(x,y)', alt: ['scatter(x, y)'], explain: 'scatter æ¯ä¸ªæ•°æ®ç‚¹ç”»ä¸€ä¸ªæ ‡è®°' },
  { prompt: 'ç»˜åˆ¶æ•°æ®çš„ç›´æ–¹å›¾', answer: 'histogram(data)', alt: ['histogram(data);', 'hist(data)'], explain: 'histogram ç»Ÿè®¡æ•°æ®åˆ†å¸ƒé¢‘ç‡' },
  { prompt: 'ç»˜åˆ¶é¥¼å›¾', answer: 'pie(data)', alt: ['pie(data);'], explain: 'pie() æŒ‰æ¯”ä¾‹ç»˜åˆ¶æ‰‡å½¢å›¾' },
  { prompt: 'ç»˜åˆ¶ä¸‰ç»´æ›²é¢å›¾', answer: 'surf(X,Y,Z)', alt: ['surf(X, Y, Z)'], explain: 'surf ç»˜åˆ¶å½©è‰²ä¸‰ç»´æ›²é¢ï¼Œmesh ç»˜åˆ¶ç½‘æ ¼æ›²é¢' },
  { prompt: 'ç»˜åˆ¶ç­‰é«˜çº¿å›¾', answer: 'contour(X,Y,Z)', alt: ['contour(X, Y, Z)', 'contour(Z)'], explain: 'contour ç»˜åˆ¶äºŒç»´ç­‰é«˜çº¿ï¼Œcontourf å¡«å……ç­‰é«˜çº¿' },

  // --- å·¥ä½œåŒº/ç³»ç»Ÿ ---
  { prompt: 'æ˜¾ç¤ºå˜é‡ x çš„å€¼', answer: 'disp(x)', alt: [], explain: 'disp() åœ¨å‘½ä»¤çª—å£æ˜¾ç¤ºå˜é‡å€¼ï¼Œä¸æ˜¾ç¤ºå˜é‡å' },
  { prompt: 'æ¸…é™¤å·¥ä½œåŒºæ‰€æœ‰å˜é‡', answer: 'clear', alt: ['clear all', 'clear;'], explain: 'clear æ¸…é™¤å˜é‡ï¼Œclc æ¸…é™¤å‘½ä»¤çª—å£' },
  { prompt: 'æ¸…é™¤å‘½ä»¤çª—å£çš„å†…å®¹', answer: 'clc', alt: ['clc;'], explain: 'clc åªæ¸…å±å¹•æ˜¾ç¤ºï¼Œä¸åˆ é™¤å˜é‡' },
  { prompt: 'åœ¨å‘½ä»¤è¡Œä¸­è·å–å¸®åŠ©ä¿¡æ¯', answer: 'help', alt: ['help;', 'doc'], explain: 'help å‡½æ•°å æŸ¥çœ‹å‡½æ•°æ–‡æ¡£ï¼Œdoc æ‰“å¼€å¸®åŠ©æµè§ˆå™¨' },
  { prompt: 'æŸ¥çœ‹å½“å‰å·¥ä½œåŒºçš„æ‰€æœ‰å˜é‡', answer: 'whos', alt: ['who'], explain: 'whos æ˜¾ç¤ºå˜é‡è¯¦æƒ…ï¼ˆåç§°ã€å¤§å°ã€ç±»å‹ï¼‰ï¼Œwho åªæ˜¾ç¤ºåç§°' },
  { prompt: 'è·å–å½“å‰å·¥ä½œç›®å½•è·¯å¾„', answer: 'pwd', alt: ['pwd;'], explain: 'pwd = print working directory' },
  { prompt: 'åˆ—å‡ºå½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶', answer: 'ls', alt: ['dir', 'ls;', 'dir;'], explain: 'ls å’Œ dir éƒ½å¯åˆ—å‡ºæ–‡ä»¶' },

  // --- å­—ç¬¦ä¸²æ“ä½œ ---
  { prompt: 'å°†å­—ç¬¦ä¸² s è½¬ä¸ºå¤§å†™', answer: 'upper(s)', alt: [], explain: 'upper() å…¨éƒ¨è½¬å¤§å†™ï¼Œlower() å…¨éƒ¨è½¬å°å†™' },
  { prompt: 'å°†å­—ç¬¦ä¸² s è½¬ä¸ºå°å†™', answer: 'lower(s)', alt: [], explain: 'lower() å°†æ‰€æœ‰å­—æ¯è½¬ä¸ºå°å†™' },
  { prompt: 'è·å–å­—ç¬¦ä¸² s çš„é•¿åº¦', answer: 'strlength(s)', alt: ['length(s)'], explain: 'strlength ç”¨äº string ç±»å‹ï¼Œlength ç”¨äºå­—ç¬¦æ•°ç»„' },
  { prompt: 'å°†æ•°å­— x è½¬æ¢ä¸ºå­—ç¬¦ä¸²', answer: 'num2str(x)', alt: ['string(x)'], explain: 'num2str è½¬ä¸ºå­—ç¬¦æ•°ç»„ï¼Œstring() è½¬ä¸º string å¯¹è±¡' },
  { prompt: 'å°†å­—ç¬¦ä¸² s è½¬æ¢ä¸ºæ•°å­—', answer: 'str2double(s)', alt: ['str2num(s)'], explain: 'str2double æ›´å®‰å…¨ï¼Œstr2num å¯æ‰§è¡Œè¡¨è¾¾å¼' },
  { prompt: 'ç”¨ sprintf æ ¼å¼åŒ–è¾“å‡ºåœ†å‘¨ç‡ä¿ç•™ä¸¤ä½å°æ•°', answer: "sprintf('%.2f',pi)", alt: ["sprintf('%.2f', pi)"], explain: "sprintf ç±»ä¼¼ C è¯­è¨€çš„æ ¼å¼åŒ–ï¼Œ%.2f è¡¨ç¤ºä¸¤ä½å°æ•°" },

  // --- æ•°æ®ç±»å‹ ---
  { prompt: 'åˆ¤æ–­ x çš„æ•°æ®ç±»å‹', answer: 'class(x)', alt: [], explain: 'class() è¿”å›å˜é‡çš„ç±»å‹åç§°å­—ç¬¦ä¸²' },
  { prompt: 'å°† x è½¬æ¢ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°', answer: 'double(x)', alt: [], explain: 'double() æ˜¯ MATLAB é»˜è®¤çš„æ•°å€¼ç±»å‹' },
  { prompt: 'å°† x è½¬æ¢ä¸º int32 ç±»å‹', answer: 'int32(x)', alt: [], explain: 'int32 æ˜¯32ä½æœ‰ç¬¦å·æ•´æ•°' },
  { prompt: 'å°† x è½¬æ¢ä¸ºé€»è¾‘ç±»å‹', answer: 'logical(x)', alt: [], explain: 'logical() éé›¶å€¼å˜ trueï¼Œé›¶å˜ false' },
  { prompt: 'åˆ›å»ºä¸€ä¸ªç©ºçš„å…ƒèƒæ•°ç»„ 3x3', answer: 'cell(3,3)', alt: ['cell(3, 3)', 'cell(3)'], explain: 'cell() åˆ›å»ºç©ºçš„å…ƒèƒæ•°ç»„ï¼Œå¯å­˜ä¸åŒç±»å‹æ•°æ®' },

  // --- æŸ¥æ‰¾/é€»è¾‘ ---
  { prompt: 'æ‰¾å‡ºå‘é‡ v ä¸­å¤§äº 5 çš„å…ƒç´ çš„ç´¢å¼•', answer: 'find(v>5)', alt: ['find(v > 5)'], explain: 'find() è¿”å›æ»¡è¶³æ¡ä»¶çš„çº¿æ€§ç´¢å¼•' },
  { prompt: 'åˆ¤æ–­å‘é‡ v ä¸­æ˜¯å¦æ‰€æœ‰å…ƒç´ éƒ½å¤§äº 0', answer: 'all(v>0)', alt: ['all(v > 0)'], explain: 'all() æ‰€æœ‰ä¸ºçœŸè¿”å› true' },
  { prompt: 'åˆ¤æ–­å‘é‡ v ä¸­æ˜¯å¦å­˜åœ¨å¤§äº 10 çš„å…ƒç´ ', answer: 'any(v>10)', alt: ['any(v > 10)'], explain: 'any() ä»»æ„ä¸€ä¸ªä¸ºçœŸè¿”å› true' },
  { prompt: 'å»é™¤å‘é‡ v ä¸­çš„é‡å¤å…ƒç´ ', answer: 'unique(v)', alt: [], explain: 'unique() è¿”å›æ’åºåçš„ä¸é‡å¤å…ƒç´ ' },

  // --- çº¿æ€§ä»£æ•° ---
  { prompt: 'å¯¹çŸ©é˜µ A è¿›è¡Œ LU åˆ†è§£', answer: 'lu(A)', alt: [], explain: '[L,U,P]=lu(A)ï¼ŒPA=LU åˆ†è§£' },
  { prompt: 'å¯¹çŸ©é˜µ A è¿›è¡Œ QR åˆ†è§£', answer: 'qr(A)', alt: [], explain: '[Q,R]=qr(A)ï¼ŒQæ­£äº¤çŸ©é˜µï¼ŒRä¸Šä¸‰è§’çŸ©é˜µ' },
  { prompt: 'å¯¹çŸ©é˜µ A è¿›è¡Œå¥‡å¼‚å€¼åˆ†è§£', answer: 'svd(A)', alt: [], explain: '[U,S,V]=svd(A)ï¼ŒA=U*S*V\x27' },
  { prompt: 'è®¡ç®—çŸ©é˜µ A çš„ä¼ªé€†', answer: 'pinv(A)', alt: [], explain: 'pinv() å¯¹ä»»æ„çŸ©é˜µï¼ˆåŒ…æ‹¬éæ–¹é˜µï¼‰æ±‚ä¼ªé€†' },
  { prompt: 'æ±‚çŸ©é˜µ A çš„æ¡ä»¶æ•°', answer: 'cond(A)', alt: [], explain: 'cond() è¶Šå¤§è¡¨ç¤ºçŸ©é˜µè¶Šç—…æ€ï¼Œæ•°å€¼è®¡ç®—è¶Šä¸ç¨³å®š' },
  { prompt: 'ç”Ÿæˆä¸€ä¸ª 3x3 çš„å¸Œå°”ä¼¯ç‰¹çŸ©é˜µ', answer: 'hilb(3)', alt: [], explain: 'hilb(n) ç”Ÿæˆç»å…¸çš„ç—…æ€çŸ©é˜µï¼Œå¸¸ç”¨äºæ•°å€¼åˆ†ææµ‹è¯•' },

  // --- å¤šé¡¹å¼ ---
  { prompt: 'æ±‚å¤šé¡¹å¼ç³»æ•°ä¸º [1 -3 2] çš„æ ¹', answer: 'roots([1 -3 2])', alt: ['roots([1,-3,2])'], explain: 'roots() æ±‚ x^2-3x+2=0 çš„æ ¹ï¼Œå³ x=1 å’Œ x=2' },
  { prompt: 'åœ¨ x=2 å¤„æ±‚å¤šé¡¹å¼ [1 -3 2] çš„å€¼', answer: 'polyval([1 -3 2],2)', alt: ['polyval([1,-3,2],2)', 'polyval([1 -3 2], 2)'], explain: 'polyval(p,x) è®¡ç®—å¤šé¡¹å¼åœ¨ x å¤„çš„å€¼' },

  // --- æ–‡ä»¶/IO ---
  { prompt: 'å°†å·¥ä½œåŒºå˜é‡ä¿å­˜åˆ°æ–‡ä»¶ data.mat', answer: "save('data.mat')", alt: ['save data.mat', "save('data.mat');"], explain: 'save å°†å˜é‡ä¿å­˜ä¸º .mat äºŒè¿›åˆ¶æ–‡ä»¶' },
  { prompt: 'ä»æ–‡ä»¶ data.mat åŠ è½½å˜é‡', answer: "load('data.mat')", alt: ['load data.mat', "load('data.mat');"], explain: 'load æ¢å¤ .mat æ–‡ä»¶ä¸­ä¿å­˜çš„å˜é‡' },
  { prompt: 'è¯»å– CSV æ–‡ä»¶ data.csv', answer: "readmatrix('data.csv')", alt: ["csvread('data.csv')"], explain: 'readmatrix æ˜¯æ¨èçš„è¯»å–æ–¹å¼ï¼ˆR2019a+ï¼‰' },

  // --- æ‚é¡¹ ---
  { prompt: 'æš‚åœç¨‹åºæ‰§è¡Œ 2 ç§’', answer: 'pause(2)', alt: [], explain: 'pause(n) æš‚åœ n ç§’ï¼Œpause ä¸å¸¦å‚æ•°ç­‰å¾…æŒ‰é”®' },
  { prompt: 'æµ‹é‡ä»£ç è¿è¡Œæ—¶é—´ï¼ˆå¯åŠ¨è®¡æ—¶å™¨ï¼‰', answer: 'tic', alt: ['tic;'], explain: 'tic å¼€å§‹è®¡æ—¶ï¼Œtoc ç»“æŸå¹¶æ˜¾ç¤ºè€—æ—¶' },
  { prompt: 'ç”Ÿæˆä¸€ä¸ª 5 é˜¶ä¼´éšçŸ©é˜µ', answer: 'compan([1 0 0 0 0 1])', alt: [], explain: 'compan(p) ç”Ÿæˆå¤šé¡¹å¼ p çš„ä¼´éšçŸ©é˜µ' },
  { prompt: 'å°†çŸ©é˜µ A æ²¿ç¬¬ä¸€ç»´åº¦æ‹¼æ¥ B', answer: 'cat(1,A,B)', alt: ['cat(1, A, B)', '[A;B]', '[A; B]'], explain: 'cat(1,A,B) ç­‰åŒäº [A;B]ï¼Œcat(2,A,B) ç­‰åŒäº [A,B]' },
  { prompt: 'å°†çŸ©é˜µ A æ²¿æ°´å¹³æ–¹å‘æ‹¼æ¥ B', answer: '[A,B]', alt: ['[A B]', 'cat(2,A,B)', 'horzcat(A,B)'], explain: '[A,B] æˆ– [A B] æ°´å¹³æ‹¼æ¥ï¼Œè¦æ±‚è¡Œæ•°ç›¸åŒ' },
  { prompt: 'åˆ›å»ºä¸€ä¸ªä» 0 åˆ° 2*pi çš„100ä¸ªç­‰è·ç‚¹', answer: 'linspace(0,2*pi,100)', alt: ['linspace(0, 2*pi, 100)'], explain: 'linspace å¸¸ç”¨äºç”Ÿæˆç»˜å›¾ç”¨çš„ x è½´æ•°æ®' },
  { prompt: 'äº¤å‰éªŒè¯ï¼šç”Ÿæˆç½‘æ ¼åæ ‡çŸ©é˜µ', answer: 'meshgrid(x,y)', alt: ['meshgrid(x, y)', '[X,Y]=meshgrid(x,y)'], explain: 'meshgrid ä¸ºä¸‰ç»´ç»˜å›¾ç”Ÿæˆåæ ‡ç½‘æ ¼' },
];

function initTerminal() {
  const screen = document.getElementById('gameTerminal');
  const tasks = shuffle([...terminalTasks]).slice(0, 8);
  let currentQ = 0, score = 0;
  let history = [];

  function renderTerminal() {
    screen.innerHTML = makeGameHeader('æé€Ÿç»ˆç«¯', 'gameTerminal',
      `<span class="game-score">å¾—åˆ†: ${score}</span><span class="game-timer">${currentQ+1}/${tasks.length}</span>`
    ) + `<div class="game-body">
      <div class="terminal-wrap">
        <div class="terminal-header">
          <span class="dot" style="background:#ff5f57"></span>
          <span class="dot" style="background:#ffbd2e"></span>
          <span class="dot" style="background:#28ca41"></span>
          <span style="margin-left:.5rem">MATLAB Command Window</span>
        </div>
        <div class="terminal-body" id="termBody">
          ${history.map(h => `<div class="terminal-line ${h.type}">${escHtml(h.text)}</div>`).join('')}
          <div class="terminal-task">â–¸ ${tasks[currentQ].prompt}</div>
          <div class="terminal-input-line">
            <span class="prompt-symbol">&gt;&gt;</span>
            <input class="terminal-input" id="termInput" autocomplete="off" autocorrect="off" spellcheck="false">
          </div>
        </div>
      </div>
    </div>`;

    const input = document.getElementById('termInput');
    input.focus();
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        AudioEngine.play('type');
        const val = input.value.trim().replace(/;$/, '');
        const task = tasks[currentQ];
        const correct = val === task.answer || val === task.answer + ';' || task.alt.includes(val) || task.alt.includes(val + ';');
        history.push({ text: `>> ${input.value}`, type: 'terminal-prompt' });
        if (correct) {
          history.push({ text: 'âœ“ æ­£ç¡®ï¼', type: 'terminal-output' });
          score += 15;
          AudioEngine.play('correct');
        } else {
          history.push({ text: `âœ— é”™è¯¯ã€‚æ­£ç¡®ç­”æ¡ˆ: ${task.answer}`, type: 'terminal-error' });
          if (task.explain) {
            history.push({ text: `  ğŸ’¡ ${task.explain}`, type: 'terminal-output' });
          }
          AudioEngine.play('wrong');
        }
        currentQ++;
        if (currentQ < tasks.length) {
          setTimeout(renderTerminal, 1200);
        } else {
          setTimeout(() => showResult('terminal', score, tasks.length * 15), 1400);
        }
      }
    });
    document.getElementById('termBody').scrollTop = 9999;
    showScreen('gameTerminal');
    setTimeout(() => input.focus(), 100);
  }

  renderTerminal();
}

// ===================== MODE 6: PLOT DETECTIVE =====================
const plotData = [
  {
    draw: (ctx, w, h) => {
      ctx.strokeStyle = '#00E5FF'; ctx.lineWidth = 2; ctx.beginPath();
      for (let i = 0; i <= w; i++) {
        const x = i; const y = h/2 - Math.sin((i/w) * 4 * Math.PI) * (h/3);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.stroke();
      drawAxes(ctx, w, h);
    },
    correct: 'plot(x, sin(x))',
    options: ['plot(x, sin(x))', 'plot(x, cos(x))', 'bar(x, sin(x))', 'stem(x, sin(x))'],
    explain: 'plot() ç»˜åˆ¶è¿ç»­çº¿å›¾ã€‚æ­¤æ³¢å½¢ä»0å¼€å§‹ã€å‘¨æœŸæ€§æŒ¯è¡ï¼Œæ˜¯å…¸å‹æ­£å¼¦æ³¢ sin(x) çš„ç‰¹å¾ã€‚'
  },
  {
    draw: (ctx, w, h) => {
      const vals = [3, 7, 2, 8, 5]; const bw = w / (vals.length * 2 + 1);
      ctx.fillStyle = '#FF6600';
      vals.forEach((v, i) => {
        const bh = (v / 10) * (h - 40);
        ctx.fillRect(bw + i * bw * 2, h - 20 - bh, bw, bh);
      });
      drawAxes(ctx, w, h);
    },
    correct: 'bar(data)',
    options: ['bar(data)', 'plot(data)', 'histogram(data)', 'stem(data)'],
    explain: 'bar() ç»˜åˆ¶æŸ±çŠ¶å›¾ï¼Œæ¯ä¸ªæ•°æ®ç‚¹å¯¹åº”ä¸€ä¸ªçŸ©å½¢æŸ±ã€‚histogram ç”¨äºé¢‘ç‡åˆ†å¸ƒç›´æ–¹å›¾ï¼Œä¸¤è€…ä¸åŒã€‚'
  },
  {
    draw: (ctx, w, h) => {
      ctx.fillStyle = '#AA66FF';
      const pts = [[.1,.3],[.2,.5],[.35,.4],[.5,.7],[.6,.6],[.75,.8],[.8,.75],[.9,.9],[.15,.2],[.45,.55]];
      pts.forEach(p => { ctx.beginPath(); ctx.arc(p[0]*w*.8+w*.1, h-p[1]*h*.8-h*.1, 4, 0, Math.PI*2); ctx.fill(); });
      drawAxes(ctx, w, h);
    },
    correct: 'scatter(x, y)',
    options: ['scatter(x, y)', 'plot(x, y)', "plot(x, y, 'o')", 'bar(x, y)'],
    explain: "scatter() ç»˜åˆ¶æ•£ç‚¹å›¾ï¼Œæ¯ä¸ªæ•°æ®ç‚¹ç”¨åœ†ç‚¹è¡¨ç¤ºã€‚plot(x,y,'o') ä¹Ÿèƒ½ç”»åœ†ç‚¹ï¼Œä½† scatter æ˜¯ä¸“ç”¨æ•£ç‚¹å›¾å‘½ä»¤ã€‚"
  },
  {
    draw: (ctx, w, h) => {
      ctx.strokeStyle = '#00FF88'; ctx.lineWidth = 2;
      const n = 10;
      for (let i = 0; i < n; i++) {
        const x = (i + 1) / (n + 1) * w;
        const v = Math.sin(i * .7) * .35 + .5;
        const y = h - v * (h - 40) - 20;
        ctx.beginPath(); ctx.moveTo(x, h - 20); ctx.lineTo(x, y); ctx.stroke();
        ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fillStyle = '#00FF88'; ctx.fill();
      }
      drawAxes(ctx, w, h);
    },
    correct: 'stem(x, y)',
    options: ['stem(x, y)', 'bar(x, y)', 'plot(x, y)', 'stairs(x, y)'],
    explain: 'stem() ç»˜åˆ¶ç«æŸ´æ£’å›¾ï¼ˆç¦»æ•£æ•°æ®å›¾ï¼‰ï¼Œæ¯ä¸ªæ•°æ®ç‚¹ç”¨ä¸€æ¡ç«–çº¿+é¡¶ç«¯åœ†ç‚¹è¡¨ç¤ºï¼Œé€‚åˆæ˜¾ç¤ºç¦»æ•£ä¿¡å·ã€‚'
  },
  {
    draw: (ctx, w, h) => {
      ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 2; ctx.beginPath();
      for (let i = 0; i <= w; i++) {
        const x = i; const y = h/2 - Math.cos((i/w) * 4 * Math.PI) * (h/3);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.stroke();
      drawAxes(ctx, w, h);
    },
    correct: 'plot(x, cos(x))',
    options: ['plot(x, cos(x))', 'plot(x, sin(x))', 'plot(x, tan(x))', 'plot(x, exp(x))'],
    explain: 'cos(x) åœ¨ x=0 å¤„å€¼ä¸º1ï¼ˆæ³¢å³°å¼€å§‹ï¼‰ï¼Œè€Œ sin(x) åœ¨ x=0 å¤„å€¼ä¸º0ã€‚è§‚å¯Ÿèµ·å§‹ç‚¹å¯ä»¥åŒºåˆ†ä¸¤è€…ã€‚'
  },
  {
    draw: (ctx, w, h) => {
      ctx.strokeStyle = '#FF3366'; ctx.lineWidth = 2;
      const vals = [2, 5, 3, 7, 4, 6];
      const sw = (w - 40) / vals.length;
      ctx.beginPath();
      vals.forEach((v, i) => {
        const y = h - 20 - (v / 8) * (h - 40);
        const x1 = 20 + i * sw, x2 = 20 + (i + 1) * sw;
        if (i === 0) ctx.moveTo(x1, y);
        else ctx.lineTo(x1, y);
        ctx.lineTo(x2, y);
      });
      ctx.stroke();
      drawAxes(ctx, w, h);
    },
    correct: 'stairs(x, y)',
    options: ['stairs(x, y)', 'plot(x, y)', 'bar(x, y)', 'stem(x, y)'],
    explain: 'stairs() ç»˜åˆ¶é˜¶æ¢¯å›¾ï¼Œæ•°æ®åœ¨æ¯æ®µä¿æŒæ°´å¹³ç„¶åè·³å˜ã€‚å¸¸ç”¨äºæ˜¾ç¤ºé‡åŒ–ä¿¡å·æˆ–ç¦»æ•£æ—¶é—´ç³»ç»Ÿçš„è¾“å‡ºã€‚'
  },
  {
    draw: (ctx, w, h) => {
      ctx.fillStyle = '#FF660044'; ctx.strokeStyle = '#FF6600'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(20, h - 20);
      for (let i = 0; i <= 50; i++) {
        const x = 20 + (i / 50) * (w - 40);
        const y = h - 20 - (Math.sin(i / 8) * .3 + .4) * (h - 40);
        ctx.lineTo(x, y);
      }
      ctx.lineTo(w - 20, h - 20); ctx.closePath(); ctx.fill();
      ctx.beginPath();
      for (let i = 0; i <= 50; i++) {
        const x = 20 + (i / 50) * (w - 40);
        const y = h - 20 - (Math.sin(i / 8) * .3 + .4) * (h - 40);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.stroke();
      drawAxes(ctx, w, h);
    },
    correct: 'area(x, y)',
    options: ['area(x, y)', 'fill(x, y)', 'plot(x, y)', 'patch(x, y)'],
    explain: 'area() ç»˜åˆ¶å¡«å……é¢ç§¯å›¾ï¼Œæ›²çº¿ä¸‹æ–¹åŒºåŸŸè¢«é¢œè‰²å¡«å……ã€‚fill ç”¨äºå¤šè¾¹å½¢å¡«å……ï¼Œpatch ç”¨äºæ›´å¤æ‚çš„å›¾å½¢å¯¹è±¡ã€‚'
  },
  {
    draw: (ctx, w, h) => {
      const vals = [30, 20, 25, 25];
      const colors = ['#FF6600', '#00E5FF', '#AA66FF', '#00FF88'];
      const cx = w/2, cy = h/2, r = Math.min(w, h) * .35;
      let start = 0;
      vals.forEach((v, i) => {
        const angle = (v / 100) * Math.PI * 2;
        ctx.beginPath(); ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, start + angle);
        ctx.closePath(); ctx.fillStyle = colors[i]; ctx.fill();
        ctx.strokeStyle = '#0a0a12'; ctx.lineWidth = 2; ctx.stroke();
        start += angle;
      });
    },
    correct: 'pie(data)',
    options: ['pie(data)', 'bar(data)', 'histogram(data)', 'polar(data)'],
    explain: 'pie() ç»˜åˆ¶é¥¼å›¾ï¼Œå°†æ•°æ®æŒ‰æ¯”ä¾‹åˆ’åˆ†ä¸ºæ‰‡å½¢ã€‚é€‚åˆå±•ç¤ºå„éƒ¨åˆ†å æ€»ä½“çš„ç™¾åˆ†æ¯”å…³ç³»ã€‚'
  },
];

function drawAxes(ctx, w, h) {
  ctx.strokeStyle = '#ffffff30'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(20, 10); ctx.lineTo(20, h - 20); ctx.lineTo(w - 10, h - 20); ctx.stroke();
}

function initPlot() {
  const screen = document.getElementById('gamePlot');
  const challenges = shuffle([...plotData]).slice(0, 6);
  let currentQ = 0, score = 0;

  function renderPlot() {
    const ch = challenges[currentQ];
    const opts = shuffle([...ch.options]);
    screen.innerHTML = makeGameHeader('å›¾å½¢ä¾¦æ¢', 'gamePlot',
      `<span class="game-score">å¾—åˆ†: ${score}</span><span class="game-timer">${currentQ+1}/${challenges.length}</span>`
    ) + `<div class="game-body">
      <div class="plot-wrap">
        <div class="plot-canvas-wrap">
          <div style="font-size:.75rem;color:var(--text2);margin-bottom:.5rem;font-family:Orbitron;letter-spacing:.1em">è¿™ä¸ªå›¾å½¢æ˜¯ç”±ä»€ä¹ˆå‘½ä»¤ç”Ÿæˆçš„ï¼Ÿ</div>
          <canvas id="plotCanvas" width="400" height="300"></canvas>
        </div>
        <div class="plot-options" id="plotOpts"></div>
      </div>
    </div>`;

    const canvas = document.getElementById('plotCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, 400, 300);
    ch.draw(ctx, 400, 300);

    const optsEl = document.getElementById('plotOpts');
    opts.forEach(o => {
      const opt = document.createElement('div');
      opt.className = 'plot-option';
      opt.textContent = o;
      opt.addEventListener('click', () => {
        AudioEngine.play('click');
        optsEl.querySelectorAll('.plot-option').forEach(el => el.style.pointerEvents = 'none');
        if (o === ch.correct) {
          opt.classList.add('correct');
          AudioEngine.play('correct');
          score += 15;
          const rect = opt.getBoundingClientRect();
          spawnParticles(rect.left + rect.width/2, rect.top, '#00FF88');
        } else {
          opt.classList.add('wrong');
          AudioEngine.play('wrong');
          optsEl.querySelectorAll('.plot-option').forEach(el => {
            if (el.textContent === ch.correct) el.classList.add('correct');
          });
        }
        // Show explanation
        if (ch.explain) {
          const exp = document.createElement('div');
          exp.style.cssText = 'margin-top:.8rem;padding:.6rem;background:#ff660015;border-left:3px solid var(--orange);border-radius:0 6px 6px 0;font-size:.8rem;color:var(--text);line-height:1.5';
          exp.textContent = 'ğŸ’¡ ' + ch.explain;
          optsEl.appendChild(exp);
        }
        // Add "next" button below options
        const isLast = currentQ + 1 >= challenges.length;
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn btn-sm btn-cyan';
        nextBtn.style.cssText = 'margin-top:.8rem;align-self:center';
        nextBtn.textContent = isLast ? 'æŸ¥çœ‹æˆç»©' : 'ä¸‹ä¸€é¢˜ â–¸';
        nextBtn.addEventListener('click', () => {
          AudioEngine.play('click');
          currentQ++;
          if (currentQ < challenges.length) renderPlot();
          else showResult('plot', score, challenges.length * 15);
        });
        optsEl.appendChild(nextBtn);
      });
      optsEl.appendChild(opt);
    });

    showScreen('gamePlot');
  }
  renderPlot();
}

// ===================== MODE 7: CODE MAZE =====================
function initMaze() {
  const screen = document.getElementById('gameMaze');
  const mazeW = 13, mazeH = 13;
  const maze = generateMaze(mazeW, mazeH);
  let playerPos = { x: 1, y: 1 };
  const exitPos = { x: mazeW - 2, y: mazeH - 2 };
  let score = 0, questionActive = false, visited = new Set();
  visited.add(`${playerPos.x},${playerPos.y}`);

  const questionCells = new Set();
  const mazeQuestions = shuffle([...mazeQData]).slice(0, 6);
  let qIdx = 0;
  const pathCells = [];
  for (let y = 0; y < mazeH; y++) for (let x = 0; x < mazeW; x++) {
    if (maze[y][x] === 0 && !(x===1&&y===1) && !(x===exitPos.x&&y===exitPos.y)) pathCells.push({x,y});
  }
  shuffle(pathCells).slice(0, mazeQuestions.length).forEach(c => questionCells.add(`${c.x},${c.y}`));

  function renderMaze() {
    screen.innerHTML = makeGameHeader('ä»£ç è¿·å®«', 'gameMaze',
      `<span class="game-score">å¾—åˆ†: ${score}</span><span style="color:var(--green);font-family:Orbitron;font-size:.8rem">WASD / æ–¹å‘é”®ç§»åŠ¨</span>`
    ) + `<div class="game-body"><div class="maze-container"><div class="maze-viewport"><div class="maze-grid-wrap" id="mazeWrap"><div class="maze-grid" id="mazeGrid" style="grid-template-columns:repeat(${mazeW},40px)"></div></div></div>
    <div class="mobile-controls">
      <div></div><button onclick="window._mazeMove(0,-1)">â–²</button><div></div>
      <button onclick="window._mazeMove(-1,0)">â—€</button><div></div><button onclick="window._mazeMove(1,0)">â–¶</button>
      <div></div><button onclick="window._mazeMove(0,1)">â–¼</button><div></div>
    </div>
    </div></div>`;

    const grid = document.getElementById('mazeGrid');
    for (let y = 0; y < mazeH; y++) {
      for (let x = 0; x < mazeW; x++) {
        const cell = document.createElement('div');
        let cls = 'maze-cell';
        if (maze[y][x] === 1) cls += ' wall';
        else cls += ' path';
        if (x === playerPos.x && y === playerPos.y) cls += ' player';
        if (x === exitPos.x && y === exitPos.y) cls += ' exit';
        if (visited.has(`${x},${y}`) && maze[y][x] === 0) cls += ' visited';
        if (questionCells.has(`${x},${y}`)) { cls += ' question-cell'; cell.textContent = '?'; }
        cell.className = cls;
        grid.appendChild(cell);
      }
    }
    showScreen('gameMaze');
  }

  window._mazeMove = (dx, dy) => movePlayer(dx, dy);

  function movePlayer(dx, dy) {
    if (questionActive) return;
    const nx = playerPos.x + dx, ny = playerPos.y + dy;
    if (nx < 0 || ny < 0 || nx >= mazeW || ny >= mazeH || maze[ny][nx] === 1) return;
    playerPos = { x: nx, y: ny };
    visited.add(`${nx},${ny}`);
    AudioEngine.play('click');

    if (nx === exitPos.x && ny === exitPos.y) {
      score += 30;
      setTimeout(() => showResult('maze', score, 30 + mazeQuestions.length * 15), 300);
      return;
    }

    renderMaze();

    const key = `${nx},${ny}`;
    if (questionCells.has(key) && qIdx < mazeQuestions.length) {
      questionCells.delete(key);
      showMazeQuestion(mazeQuestions[qIdx++]);
    }
  }

  function showMazeQuestion(q) {
    questionActive = true;
    const popup = document.createElement('div');
    popup.className = 'maze-question-popup';
    popup.innerHTML = `<h3>&#9670; ä»£ç å…³å¡ &#9670;</h3><pre>${escHtml(q.code)}</pre><div class="mq-options">${
      q.options.map((o, i) => `<div class="mq-opt" data-i="${i}">${escHtml(o)}</div>`).join('')
    }</div><div class="mq-explain" style="display:none;margin-top:.8rem;padding:.6rem;background:#ff660015;border-left:3px solid var(--orange);border-radius:0 6px 6px 0;font-size:.75rem;color:var(--text);line-height:1.5"></div><div style="text-align:center;margin-top:.8rem"><button class="btn btn-sm btn-cyan" style="display:none" id="mqContinue">ç»§ç»­æ¢ç´¢ â–¸</button></div>`;
    document.body.appendChild(popup);

    const explainEl = popup.querySelector('.mq-explain');
    const continueBtn = popup.querySelector('#mqContinue');

    popup.querySelectorAll('.mq-opt').forEach(opt => {
      opt.addEventListener('click', () => {
        // Disable all options
        popup.querySelectorAll('.mq-opt').forEach(o => o.style.pointerEvents = 'none');
        const correct = +opt.dataset.i === q.correct;
        if (correct) {
          AudioEngine.play('correct'); score += 15; opt.style.borderColor = 'var(--green)'; opt.style.background = '#00ff8820';
        } else {
          AudioEngine.play('wrong'); opt.style.borderColor = 'var(--red)'; opt.style.background = '#ff336620';
          popup.querySelectorAll('.mq-opt')[q.correct].style.borderColor = 'var(--green)';
          popup.querySelectorAll('.mq-opt')[q.correct].style.background = '#00ff8810';
        }
        // Show explanation
        if (q.explain) {
          explainEl.textContent = 'ğŸ’¡ ' + q.explain;
          explainEl.style.display = 'block';
        }
        // Show continue button
        continueBtn.style.display = 'inline-block';
        continueBtn.addEventListener('click', () => {
          AudioEngine.play('click');
          popup.remove();
          questionActive = false;
          renderMaze();
        });
      });
    });
  }

  function handleKey(e) {
    if (state.currentMode !== 'maze') { document.removeEventListener('keydown', handleKey); return; }
    const map = { ArrowUp: [0,-1], ArrowDown: [0,1], ArrowLeft: [-1,0], ArrowRight: [1,0],
                   w: [0,-1], s: [0,1], a: [-1,0], d: [1,0],
                   W: [0,-1], S: [0,1], A: [-1,0], D: [1,0] };
    if (map[e.key]) { e.preventDefault(); movePlayer(...map[e.key]); }
  }
  document.addEventListener('keydown', handleKey);

  renderMaze();
}

const mazeQData = [
  { code: 'A = [1 2; 3 4];\nB = A(2,:);\ndisp(B)', options: ['[3 4]', '[2; 4]', '[1 2]', '[3; 4]'], correct: 0, explain: 'A(2,:) å–ç¬¬2è¡Œæ‰€æœ‰åˆ—ã€‚Açš„ç¬¬2è¡Œæ˜¯ [3 4]ã€‚å†’å· : è¡¨ç¤ºé€‰å–è¯¥ç»´åº¦çš„å…¨éƒ¨å…ƒç´ ã€‚' },
  { code: 'x = 5;\nif x > 3\n  y = x^2;\nelse\n  y = x;\nend\ndisp(y)', options: ['25', '5', '3', 'é”™è¯¯'], correct: 0, explain: 'x=5 > 3 ä¸º trueï¼Œè¿›å…¥ if åˆ†æ”¯ï¼Œy = 5^2 = 25ã€‚' },
  { code: 'v = 1:2:9;\ndisp(length(v))', options: ['5', '4', '9', '3'], correct: 0, explain: '1:2:9 ç”Ÿæˆ [1 3 5 7 9]ï¼ˆä»1å¼€å§‹ï¼Œæ­¥é•¿2ï¼Œåˆ°9ä¸ºæ­¢ï¼‰ï¼Œå…±5ä¸ªå…ƒç´ ã€‚' },
  { code: 'A = eye(3);\ndisp(sum(A(:)))', options: ['3', '9', '1', '0'], correct: 0, explain: 'eye(3) æ˜¯3é˜¶å•ä½çŸ©é˜µï¼Œå¯¹è§’çº¿ä¸º1å…¶ä½™ä¸º0ã€‚A(:) å°†çŸ©é˜µå±•å¼€ä¸ºåˆ—å‘é‡ï¼Œsum æ±‚å’Œ = 3ã€‚' },
  { code: 'x = [4 1 3 2];\ny = sort(x);\ndisp(y(end))', options: ['4', '1', '2', '3'], correct: 0, explain: 'sort å‡åºæ’åˆ—å¾— [1 2 3 4]ï¼Œy(end) å–æœ€åä¸€ä¸ªå…ƒç´  = 4ã€‚' },
  { code: "s = 'MATLAB';\ndisp(s(1:3))", options: ['MAT', 'MATL', 'LAB', 'M'], correct: 0, explain: "å­—ç¬¦ä¸²å¯ä»¥åƒæ•°ç»„ä¸€æ ·ç´¢å¼•ã€‚s(1:3) å–ç¬¬1åˆ°ç¬¬3ä¸ªå­—ç¬¦ = 'MAT'ã€‚" },
  { code: 'A = [1 2; 3 4];\ndisp(det(A))', options: ['-2', '2', '10', '0'], correct: 0, explain: '2é˜¶çŸ©é˜µè¡Œåˆ—å¼ = a*d - b*c = 1*4 - 2*3 = -2ã€‚' },
  { code: 'x = linspace(0,1,5);\ndisp(x(3))', options: ['0.5', '0.25', '0.75', '0.3333'], correct: 0, explain: 'linspace(0,1,5) = [0, 0.25, 0.5, 0.75, 1]ï¼Œç¬¬3ä¸ªå…ƒç´  = 0.5ã€‚' },
  { code: 'A = ones(2,3);\ndisp(size(A,2))', options: ['3', '2', '6', '1'], correct: 0, explain: 'ones(2,3) åˆ›å»º2è¡Œ3åˆ—å…¨1çŸ©é˜µã€‚size(A,2) è¿”å›ç¬¬2ä¸ªç»´åº¦(åˆ—æ•°) = 3ã€‚' },
  { code: 'v = [10 20 30];\nv(end+1) = 40;\ndisp(length(v))', options: ['4', '3', 'é”™è¯¯', '40'], correct: 0, explain: 'v(end+1)=40 åœ¨å‘é‡æœ«å°¾è¿½åŠ å…ƒç´ ï¼Œv å˜ä¸º [10 20 30 40]ï¼Œé•¿åº¦ = 4ã€‚' },
];

function generateMaze(w, h) {
  const grid = Array.from({length: h}, () => Array(w).fill(1));
  function carve(x, y) {
    grid[y][x] = 0;
    const dirs = shuffle([[0,-2],[0,2],[-2,0],[2,0]]);
    for (const [dx, dy] of dirs) {
      const nx = x + dx, ny = y + dy;
      if (nx > 0 && ny > 0 && nx < w - 1 && ny < h - 1 && grid[ny][nx] === 1) {
        grid[y + dy/2][x + dx/2] = 0;
        carve(nx, ny);
      }
    }
  }
  carve(1, 1);
  grid[h-2][w-2] = 0;
  if (grid[h-3][w-2] === 1 && grid[h-2][w-3] === 1) {
    grid[h-3][w-2] = 0;
  }
  return grid;
}

// ===================== MODE 8: OUTPUT PREDICT (NEW) =====================
const outputData = [
  {
    code: "A = [1 2; 3 4];\nB = A * A;\ndisp(B(1,2))",
    answer: "10",
    hint: "çŸ©é˜µä¹˜æ³• A*A = [1*1+2*3, 1*2+2*4; 3*1+4*3, 3*2+4*4]"
  },
  {
    code: "x = 1:5;\ny = x.^2;\ndisp(sum(y))",
    answer: "55",
    hint: "1^2+2^2+3^2+4^2+5^2 = 1+4+9+16+25 = 55"
  },
  {
    code: "A = [3 1 4; 1 5 9; 2 6 5];\ndisp(A(2,3))",
    answer: "9",
    hint: "A(2,3) è¡¨ç¤ºç¬¬2è¡Œç¬¬3åˆ—çš„å…ƒç´ "
  },
  {
    code: "v = [10 20 30 40 50];\ndisp(v(end-1))",
    answer: "40",
    hint: "end è¡¨ç¤ºæœ€åä¸€ä¸ªç´¢å¼•ï¼Œend-1 å°±æ˜¯å€’æ•°ç¬¬äºŒä¸ª"
  },
  {
    code: "x = 'Hello';\ndisp(length(x))",
    answer: "5",
    hint: "å­—ç¬¦ä¸² 'Hello' æœ‰5ä¸ªå­—ç¬¦"
  },
  {
    code: "A = zeros(3);\nA(2,2) = 7;\ndisp(sum(A(:)))",
    answer: "7",
    hint: "3x3é›¶çŸ©é˜µä¸­åªæœ‰(2,2)ä½ç½®æ˜¯7ï¼Œæ‰€æœ‰å…ƒç´ ä¹‹å’Œå°±æ˜¯7"
  },
  {
    code: "v = [5 3 8 1 4];\n[m, idx] = max(v);\ndisp(idx)",
    answer: "3",
    hint: "æœ€å¤§å€¼8åœ¨ç¬¬3ä¸ªä½ç½®"
  },
  {
    code: "A = [1 2; 3 4];\nB = A';\ndisp(B(1,2))",
    answer: "3",
    hint: "è½¬ç½®å B = [1 3; 2 4]ï¼ŒB(1,2) = 3"
  },
  {
    code: "x = 10;\nwhile x > 1\n    x = x / 2;\nend\ndisp(x)",
    answer: "0.6250",
    hint: "10->5->2.5->1.25->0.625ï¼Œå½“x=0.625æ—¶ä¸æ»¡è¶³x>1é€€å‡ºå¾ªç¯",
    altAnswers: ["0.625", "0.62500"]
  },
  {
    code: "v = [2 4 6 8 10];\nidx = find(v > 5);\ndisp(length(idx))",
    answer: "3",
    hint: "å¤§äº5çš„å…ƒç´ æœ‰ 6,8,10 å…±3ä¸ª"
  },
  {
    code: "A = eye(4);\ndisp(trace(A))",
    answer: "4",
    hint: "4é˜¶å•ä½çŸ©é˜µçš„è¿¹ï¼ˆå¯¹è§’çº¿å…ƒç´ ä¹‹å’Œï¼‰= 4"
  },
  {
    code: "s = 'MATLAB';\ndisp(s(end:-1:1))",
    answer: "BALTAM",
    hint: "end:-1:1 è¡¨ç¤ºä»æœ€åä¸€ä¸ªå­—ç¬¦åˆ°ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå³åè½¬å­—ç¬¦ä¸²"
  },
];

function initOutput() {
  const screen = document.getElementById('gameOutput');
  const challenges = shuffle([...outputData]).slice(0, 6);
  let currentQ = 0, score = 0;

  function renderOutput() {
    const ch = challenges[currentQ];
    screen.innerHTML = makeGameHeader('è¾“å‡ºé¢„æµ‹', 'gameOutput',
      `<span class="game-score">å¾—åˆ†: ${score}</span><span class="game-timer">${currentQ+1}/${challenges.length}</span>`
    ) + `<div class="game-body">
      <div class="output-wrap">
        <div class="output-code-box">
          <div class="output-code-header">
            <span class="dot" style="background:#ff5f57;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#ffbd2e;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#28ca41;width:8px;height:8px;border-radius:50%"></span>
            <span style="margin-left:.5rem">predict_output.m</span>
          </div>
          <div class="output-code-body">${escHtml(ch.code)}</div>
        </div>
        <div class="output-input-area">
          <div class="output-label">â–¸ è¿™æ®µä»£ç çš„è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ</div>
          <textarea class="output-textarea" id="outputAnswer" placeholder="è¾“å…¥ä½ è®¤ä¸ºçš„è¾“å‡ºç»“æœ..." rows="2"></textarea>
          <div class="output-expected" id="outputExpected"></div>
        </div>
      </div>
    </div>
    <div class="game-footer">
      <button class="btn btn-sm btn-cyan" id="outputSubmit">æäº¤é¢„æµ‹</button>
      <button class="btn btn-sm" id="outputHint" style="border-color:var(--gold);color:var(--gold)">æç¤º (-5åˆ†)</button>
    </div>`;

    let hintUsed = false;
    document.getElementById('outputHint').addEventListener('click', () => {
      if (hintUsed) return;
      hintUsed = true;
      const hintEl = document.createElement('div');
      hintEl.style.cssText = 'margin-top:.5rem;padding:.6rem;background:#ffd70015;border:1px solid var(--gold);border-radius:6px;font-size:.8rem;color:var(--gold);line-height:1.4';
      hintEl.textContent = 'ğŸ’¡ ' + ch.hint;
      document.querySelector('.output-input-area').appendChild(hintEl);
      AudioEngine.play('click');
    });

    document.getElementById('outputSubmit').addEventListener('click', () => {
      const userAnswer = document.getElementById('outputAnswer').value.trim();
      const expectedEl = document.getElementById('outputExpected');
      const allAnswers = [ch.answer, ...(ch.altAnswers || [])];
      const correct = allAnswers.some(a => userAnswer === a);
      expectedEl.style.display = 'block';
      if (correct) {
        expectedEl.textContent = 'âœ“ æ­£ç¡®ï¼è¾“å‡º: ' + ch.answer;
        expectedEl.className = 'output-expected';
        AudioEngine.play('correct');
        score += hintUsed ? 15 : 20;
        spawnParticles(window.innerWidth/2, window.innerHeight/2, '#00FF88', 15);
      } else {
        expectedEl.textContent = 'âœ— æ­£ç¡®ç­”æ¡ˆ: ' + ch.answer + (ch.hint ? '\nğŸ’¡ ' + ch.hint : '');
        expectedEl.className = 'output-expected wrong-bg';
        AudioEngine.play('wrong');
      }
      document.getElementById('outputAnswer').disabled = true;
      // Replace footer with "next" button
      const footer = screen.querySelector('.game-footer');
      const isLast = currentQ + 1 >= challenges.length;
      footer.innerHTML = `<button class="btn btn-sm btn-cyan" id="outputNext">${isLast ? 'æŸ¥çœ‹æˆç»©' : 'ä¸‹ä¸€é¢˜ â–¸'}</button>`;
      document.getElementById('outputNext').addEventListener('click', () => {
        AudioEngine.play('click');
        currentQ++;
        if (currentQ < challenges.length) renderOutput();
        else showResult('output', score, challenges.length * 20);
      });
    });

    // Allow Enter to submit
    document.getElementById('outputAnswer').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('outputSubmit').click();
      }
    });

    showScreen('gameOutput');
    setTimeout(() => document.getElementById('outputAnswer').focus(), 100);
  }

  renderOutput();
}

// ===================== MODE 9: FILL IN THE BLANKS (NEW) =====================
const fillData = [
  {
    desc: 'ä½¿ç”¨ for å¾ªç¯è®¡ç®—é˜¶ä¹˜ 5!',
    template: ['result = 1;', 'for i = ___:___', '    result = result ___ i;', 'end'],
    blanks: ['2', '5', '*'],
    display: ['result = 1;', 'for i = <BLANK>:<BLANK>', '    result = result <BLANK> i;', 'end'],
    explain: 'é˜¶ä¹˜ 5! = 1Ã—2Ã—3Ã—4Ã—5 = 120ã€‚result åˆå§‹ä¸º1ï¼Œä» i=2 å¾ªç¯åˆ° i=5ï¼Œæ¯æ¬¡ result = result * iã€‚'
  },
  {
    desc: 'ç”Ÿæˆç­‰é—´è·å‘é‡å¹¶ç»˜åˆ¶æ­£å¼¦æ›²çº¿',
    template: ['x = ___(0, 2*pi, 100);', 'y = ___(x);', '___(x, y);'],
    blanks: ['linspace', 'sin', 'plot'],
    display: ['x = <BLANK>(0, 2*pi, 100);', 'y = <BLANK>(x);', '<BLANK>(x, y);'],
    explain: 'linspace ç”Ÿæˆç­‰é—´è·å‘é‡ï¼Œsin è®¡ç®—æ­£å¼¦å€¼ï¼Œplot å°†æ•°æ®ç»˜åˆ¶æˆæ›²çº¿å›¾ã€‚è¿™æ˜¯ MATLAB ç”»å›¾çš„æ ‡å‡†æµç¨‹ã€‚'
  },
  {
    desc: 'åˆ›å»ºçŸ©é˜µå¹¶æå–å­çŸ©é˜µ',
    template: ['A = ___(4);', 'B = A(1:2, ___);', 'disp(___);'],
    blanks: ['eye', '1:2', 'B'],
    display: ['A = <BLANK>(4);', 'B = A(1:2, <BLANK>);', 'disp(<BLANK>);'],
    explain: 'eye(4) ç”Ÿæˆ4é˜¶å•ä½çŸ©é˜µã€‚A(1:2, 1:2) æå–å·¦ä¸Šè§’2Ã—2å­çŸ©é˜µã€‚disp(B) æ˜¾ç¤ºç»“æœã€‚'
  },
  {
    desc: 'è§£çº¿æ€§æ–¹ç¨‹ç»„ Ax = b',
    template: ['A = [2 1; 5 3];', 'b = [4; 7];', 'x = A ___ b;'],
    blanks: ['\\'],
    display: ['A = [2 1; 5 3];', 'b = [4; 7];', 'x = A <BLANK> b;'],
    explain: 'åœ¨ MATLAB ä¸­ç”¨åæ–œæ  \\ æ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„ Ax=bï¼Œå³ x = A\\bã€‚è¿™æ¯” inv(A)*b æ›´é«˜æ•ˆä¸”æ•°å€¼æ›´ç¨³å®šã€‚'
  },
  {
    desc: 'ç”¨æ¡ä»¶è¯­å¥åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯æ­£ã€è´Ÿè¿˜æ˜¯é›¶',
    template: ['x = -5;', '___ x > 0', "    disp('æ­£æ•°');", '___ x < 0', "    disp('è´Ÿæ•°');", '___', "    disp('é›¶');", 'end'],
    blanks: ['if', 'elseif', 'else'],
    display: ['x = -5;', '<BLANK> x > 0', "    disp('æ­£æ•°');", '<BLANK> x < 0', "    disp('è´Ÿæ•°');", '<BLANK>', "    disp('é›¶');", 'end'],
    explain: 'if-elseif-else æ˜¯ MATLAB çš„æ¡ä»¶åˆ†æ”¯ç»“æ„ã€‚ä¾æ¬¡åˆ¤æ–­æ¡ä»¶ï¼ŒåŒ¹é…åˆ™æ‰§è¡Œå¯¹åº”ä»£ç å—ã€‚else å¤„ç†æ‰€æœ‰å‰©ä½™æƒ…å†µã€‚'
  },
  {
    desc: 'åˆ›å»ºä¸€ä¸ªå‡½æ•°æ±‚ä¸¤ä¸ªæ•°çš„æœ€å¤§å…¬çº¦æ•°ï¼ˆä½¿ç”¨é€’å½’ï¼‰',
    template: ['___ result = myGcd(a, b)', '    if b == 0', '        result = ___;', '    else', '        result = myGcd(b, ___(a, b));', '    end', 'end'],
    blanks: ['function', 'a', 'mod'],
    display: ['<BLANK> result = myGcd(a, b)', '    if b == 0', '        result = <BLANK>;', '    else', '        result = myGcd(b, <BLANK>(a, b));', '    end', 'end'],
    explain: 'è¾—è½¬ç›¸é™¤æ³•ï¼šgcd(a,b) = gcd(b, mod(a,b))ï¼Œå½“ b=0 æ—¶ç»“æœä¸º aã€‚function å£°æ˜å‡½æ•°ï¼Œmod æ±‚ä½™æ•°ã€‚'
  },
  {
    desc: 'ç”¨ arrayfun å¯¹æ•°ç»„å…ƒç´ åº”ç”¨å‡½æ•°',
    template: ['f = @(x) x^2 + 2*x + 1;', 'v = 1:5;', 'result = ___(f, v);', '___(result);'],
    blanks: ['arrayfun', 'disp'],
    display: ['f = @(x) x^2 + 2*x + 1;', 'v = 1:5;', 'result = <BLANK>(f, v);', '<BLANK>(result);'],
    explain: '@(x) åˆ›å»ºåŒ¿åå‡½æ•°ã€‚arrayfun å¯¹æ•°ç»„æ¯ä¸ªå…ƒç´ åº”ç”¨å‡½æ•°ï¼Œé¿å…å†™ for å¾ªç¯ã€‚disp æ˜¾ç¤ºç»“æœã€‚'
  },
  {
    desc: 'è¯»å–æ–‡ä»¶æ•°æ®å¹¶ç»˜åˆ¶å›¾è¡¨',
    template: ['data = ___(\'data.csv\');', 'x = data(:, 1);', 'y = data(:, ___);', 'plot(x, y);', '___("Data Plot");'],
    blanks: ['readmatrix', '2', 'title'],
    display: ['data = <BLANK>(\'data.csv\');', 'x = data(:, 1);', 'y = data(:, <BLANK>);', 'plot(x, y);', '<BLANK>("Data Plot");'],
    explain: 'readmatrix è¯»å– CSV æ–‡ä»¶ä¸ºçŸ©é˜µã€‚data(:,1) å–ç¬¬1åˆ—ä½œä¸º xï¼Œdata(:,2) å–ç¬¬2åˆ—ä½œä¸º yã€‚title è®¾ç½®å›¾æ ‡é¢˜ã€‚'
  },
];

function initFill() {
  const screen = document.getElementById('gameFill');
  const challenges = shuffle([...fillData]).slice(0, 5);
  let currentQ = 0, score = 0;

  function renderFill() {
    const ch = challenges[currentQ];
    let blankIdx = 0;
    let codeHtml = '';
    ch.display.forEach((line, lineIdx) => {
      let processedLine = escHtml(line);
      // Replace <BLANK> placeholders with input fields
      while (processedLine.includes('&lt;BLANK&gt;')) {
        processedLine = processedLine.replace('&lt;BLANK&gt;',
          `<input class="fill-blank" data-blank="${blankIdx}" placeholder="?" style="width:${Math.max(60, ch.blanks[blankIdx].length * 12)}px">`);
        blankIdx++;
      }
      codeHtml += processedLine + '\n';
    });

    screen.innerHTML = makeGameHeader('ä»£ç å¡«ç©º', 'gameFill',
      `<span class="game-score">å¾—åˆ†: ${score}</span><span class="game-timer">${currentQ+1}/${challenges.length}</span>`
    ) + `<div class="game-body">
      <div class="fill-wrap">
        <div class="fill-desc">âœï¸ ${ch.desc}</div>
        <div class="fill-code-box">
          <div class="output-code-header">
            <span class="dot" style="background:#ff5f57;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#ffbd2e;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#28ca41;width:8px;height:8px;border-radius:50%"></span>
            <span style="margin-left:.5rem">fill_blanks.m</span>
          </div>
          <div class="fill-code-body" id="fillCode">${codeHtml}</div>
        </div>
      </div>
    </div>
    <div class="game-footer">
      <button class="btn btn-sm btn-cyan" id="fillSubmit">æäº¤ç­”æ¡ˆ</button>
    </div>`;

    // Auto-focus first blank
    const firstBlank = screen.querySelector('.fill-blank[data-blank="0"]');
    if (firstBlank) setTimeout(() => firstBlank.focus(), 100);

    // Tab between blanks
    screen.querySelectorAll('.fill-blank').forEach(inp => {
      inp.addEventListener('keydown', e => {
        if (e.key === 'Tab') {
          e.preventDefault();
          const next = +inp.dataset.blank + 1;
          const nextEl = screen.querySelector(`.fill-blank[data-blank="${next}"]`);
          if (nextEl) nextEl.focus();
          else document.getElementById('fillSubmit').focus();
        }
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('fillSubmit').click();
        }
      });
    });

    document.getElementById('fillSubmit').addEventListener('click', () => {
      const blanks = screen.querySelectorAll('.fill-blank');
      let allCorrect = true;
      blanks.forEach(inp => {
        const idx = +inp.dataset.blank;
        const userVal = inp.value.trim();
        if (userVal === ch.blanks[idx]) {
          inp.classList.add('correct');
        } else {
          inp.classList.add('wrong');
          allCorrect = false;
          // Show correct answer in tooltip-like fashion
          inp.title = 'æ­£ç¡®ç­”æ¡ˆ: ' + ch.blanks[idx];
          inp.value = ch.blanks[idx];
          inp.style.fontSize = '.75rem';
        }
        inp.disabled = true;
      });

      if (allCorrect) {
        AudioEngine.play('correct');
        score += 20;
        spawnParticles(window.innerWidth/2, window.innerHeight/2, '#00FF88', 15);
      } else {
        AudioEngine.play('wrong');
      }

      // Show explanation
      if (ch.explain) {
        const wrap = screen.querySelector('.fill-wrap');
        const exp = document.createElement('div');
        exp.style.cssText = 'margin-top:1rem;padding:1rem;background:#ff660015;border-left:3px solid var(--orange);border-radius:0 8px 8px 0;font-size:.8rem;color:var(--text);line-height:1.6';
        exp.textContent = (allCorrect ? 'âœ“ ' : 'ğŸ’¡ ') + ch.explain;
        wrap.appendChild(exp);
      }

      // Replace footer with "next" button
      const footer = screen.querySelector('.game-footer');
      const isLast = currentQ + 1 >= challenges.length;
      footer.innerHTML = `<button class="btn btn-sm btn-cyan" id="fillNext">${isLast ? 'æŸ¥çœ‹æˆç»©' : 'ä¸‹ä¸€é¢˜ â–¸'}</button>`;
      document.getElementById('fillNext').addEventListener('click', () => {
        AudioEngine.play('click');
        currentQ++;
        if (currentQ < challenges.length) renderFill();
        else showResult('fill', score, challenges.length * 20);
      });
    });

    showScreen('gameFill');
  }

  renderFill();
}

// ===================== PER-MODE ENDLESS =====================
function initModeEndless(modeId) {
  const screen = document.getElementById('gameEndless');
  let totalScore = 0, streak = 0, bestStreak = 0, questionNum = 0;
  const modeInfo = modes.find(m => m.id === modeId);
  const modeName = modeInfo ? modeInfo.name : modeId;
  const modeIcon = modeInfo ? modeInfo.icon : 'â™¾ï¸';

  function makeHeader() {
    return makeGameHeader(`${modeName} Â· æ— å°½`, 'gameEndless',
      `<span class="game-score">å¾—åˆ†: ${totalScore}</span><span class="game-timer" style="color:var(--gold)">ğŸ”¥ ${streak}</span><span class="game-timer">æœ€ä½³: ${bestStreak}</span><span class="game-timer">#${questionNum}</span>`
    );
  }
  function addNextBtn(container) {
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm btn-cyan';
    btn.style.cssText = 'margin-top:.8rem';
    btn.textContent = 'ä¸‹ä¸€é¢˜ â–¸';
    btn.addEventListener('click', () => { AudioEngine.play('click'); renderNext(); });
    container.appendChild(btn);
  }
  function addExplain(container, text) {
    if (!text) return;
    const exp = document.createElement('div');
    exp.style.cssText = 'margin-top:.8rem;padding:.6rem;background:#ff660015;border-left:3px solid var(--orange);border-radius:0 6px 6px 0;font-size:.8rem;color:var(--text);line-height:1.5';
    exp.textContent = 'ğŸ’¡ ' + text;
    container.appendChild(exp);
  }
  function onCorrect() {
    AudioEngine.play('correct'); streak++;
    if (streak > bestStreak) bestStreak = streak;
    totalScore += 10 + Math.min(streak, 5);
    spawnParticles(window.innerWidth/2, window.innerHeight/2, '#00FF88', 15);
  }
  function onWrong() { AudioEngine.play('wrong'); streak = 0; }

  // Build pool for this mode
  let pool = [], poolIdx = 0;
  function resetPool(src) { pool = shuffle([...src]); poolIdx = 0; }
  function next() { if (poolIdx >= pool.length) { pool = shuffle([...pool]); poolIdx = 0; } return pool[poolIdx++]; }

  // ---- TERMINAL endless ----
  function initTerminalEndless() {
    resetPool(terminalTasks);
    function render() {
      const q = next(); questionNum++;
      screen.innerHTML = makeHeader() + `<div class="game-body">
        <div style="max-width:550px;width:100%">
          <div class="terminal-wrap" style="background:var(--bg);border:1px solid #ffffff15;border-radius:8px;padding:1rem;max-height:none">
            <div style="font-size:.75rem;color:var(--text2);margin-bottom:.8rem;font-family:'Fira Code'">% ${escHtml(q.prompt)}</div>
            <div style="display:flex;align-items:center;gap:.5rem">
              <span style="color:var(--green);font-family:'Fira Code';font-size:.85rem">>></span>
              <input type="text" id="elTermInput" style="flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'Fira Code';font-size:.85rem;caret-color:var(--orange)" autocomplete="off" autocorrect="off" spellcheck="false">
            </div>
            <div id="elArea" style="margin-top:.8rem"></div>
          </div>
        </div>
      </div>
      <div class="game-footer"><span style="font-size:.7rem;color:var(--text2)">è¾“å…¥ MATLAB å‘½ä»¤åæŒ‰ Enter</span></div>`;
      const input = document.getElementById('elTermInput');
      const area = document.getElementById('elArea');
      setTimeout(() => input.focus(), 100);
      let answered = false;
      input.addEventListener('keydown', e => {
        if (e.key !== 'Enter' || answered) return;
        answered = true; input.disabled = true;
        const val = input.value.trim().replace(/;$/, '');
        const correct = val === q.answer || (q.alt && q.alt.includes(val));
        const fb = document.createElement('div');
        fb.style.cssText = 'font-family:"Fira Code";font-size:.85rem;margin-top:.3rem';
        if (correct) { fb.innerHTML = '<span style="color:var(--green)">âœ“ æ­£ç¡®ï¼</span>'; onCorrect(); }
        else { fb.innerHTML = `<span style="color:var(--red)">âœ— é”™è¯¯</span> <span style="color:var(--text2)">æ­£ç¡®ç­”æ¡ˆ: <span style="color:var(--green)">${escHtml(q.answer)}</span></span>`; onWrong(); }
        area.appendChild(fb);
        addExplain(area, q.explain);
        addNextBtn(area);
      });
      showScreen('gameEndless');
    }
    return render;
  }

  // ---- OUTPUT endless ----
  function initOutputEndless() {
    resetPool(outputData);
    function render() {
      const q = next(); questionNum++;
      screen.innerHTML = makeHeader() + `<div class="game-body">
        <div class="output-wrap" style="max-width:550px">
          <div class="output-code-box">
            <div class="output-code-header">
              <span class="dot" style="background:#ff5f57;width:8px;height:8px;border-radius:50%"></span>
              <span class="dot" style="background:#ffbd2e;width:8px;height:8px;border-radius:50%"></span>
              <span class="dot" style="background:#28ca41;width:8px;height:8px;border-radius:50%"></span>
              <span style="margin-left:.5rem">predict.m</span>
            </div>
            <div class="output-code-body">${escHtml(q.code)}</div>
          </div>
          <div style="margin-top:1rem;display:flex;gap:.5rem;align-items:center">
            <span style="font-size:.8rem;color:var(--text2)">è¾“å‡º =</span>
            <input type="text" id="elOutInput" style="flex:1;background:var(--bg);border:1px solid #ffffff20;border-radius:6px;padding:.5rem .8rem;color:var(--text);font-family:'Fira Code';font-size:.85rem;outline:none" autocomplete="off" placeholder="è¾“å…¥ç¨‹åºè¾“å‡º...">
            <button class="btn btn-sm btn-cyan" id="elOutSubmit">æäº¤</button>
          </div>
          <div id="elArea" style="margin-top:.8rem"></div>
        </div>
      </div>
      <div class="game-footer"><span style="font-size:.7rem;color:var(--text2)">é¢„æµ‹ä»£ç çš„è¾“å‡ºç»“æœ</span></div>`;
      const input = document.getElementById('elOutInput');
      const submitBtn = document.getElementById('elOutSubmit');
      const area = document.getElementById('elArea');
      setTimeout(() => input.focus(), 100);
      let answered = false;
      function doSubmit() {
        if (answered) return; answered = true;
        const val = input.value.trim();
        const alts = q.altAnswers || [];
        const correct = val === q.answer || alts.includes(val);
        input.disabled = true; submitBtn.disabled = true;
        const fb = document.createElement('div');
        fb.style.cssText = 'font-size:.85rem;margin-top:.3rem';
        if (correct) { fb.innerHTML = '<span style="color:var(--green)">âœ“ æ­£ç¡®ï¼</span>'; onCorrect(); }
        else { fb.innerHTML = `<span style="color:var(--red)">âœ— é”™è¯¯</span> <span style="color:var(--text2)">æ­£ç¡®ç­”æ¡ˆ: <span style="color:var(--green)">${escHtml(q.answer)}</span></span>`; onWrong(); }
        area.appendChild(fb);
        addExplain(area, q.hint || '');
        addNextBtn(area);
      }
      submitBtn.addEventListener('click', doSubmit);
      input.addEventListener('keydown', e => { if (e.key === 'Enter') doSubmit(); });
      showScreen('gameEndless');
    }
    return render;
  }

  // ---- FILL endless ----
  function initFillEndless() {
    resetPool(fillData);
    function render() {
      const q = next(); questionNum++;
      let blankIdx = 0, codeHtml = '';
      q.display.forEach(line => {
        let p = escHtml(line);
        while (p.includes('&lt;BLANK&gt;')) {
          p = p.replace('&lt;BLANK&gt;', `<input class="fill-blank" data-blank="${blankIdx}" placeholder="?" style="width:${Math.max(60, q.blanks[blankIdx].length * 12)}px">`);
          blankIdx++;
        }
        codeHtml += p + '\n';
      });
      screen.innerHTML = makeHeader() + `<div class="game-body">
        <div class="fill-wrap" style="max-width:550px;width:100%">
          <div class="fill-desc">âœï¸ ${q.desc}</div>
          <div class="fill-code-box">
            <div class="output-code-header">
              <span class="dot" style="background:#ff5f57;width:8px;height:8px;border-radius:50%"></span>
              <span class="dot" style="background:#ffbd2e;width:8px;height:8px;border-radius:50%"></span>
              <span class="dot" style="background:#28ca41;width:8px;height:8px;border-radius:50%"></span>
              <span style="margin-left:.5rem">fill_blanks.m</span>
            </div>
            <div class="fill-code-body">${codeHtml}</div>
          </div>
          <div id="elArea" style="margin-top:.8rem"></div>
        </div>
      </div>
      <div class="game-footer"><button class="btn btn-sm btn-cyan" id="elFillSubmit">æäº¤ç­”æ¡ˆ</button></div>`;
      const firstBlank = screen.querySelector('.fill-blank[data-blank="0"]');
      if (firstBlank) setTimeout(() => firstBlank.focus(), 100);
      screen.querySelectorAll('.fill-blank').forEach(inp => {
        inp.addEventListener('keydown', e => {
          if (e.key === 'Tab') { e.preventDefault(); const nx = screen.querySelector(`.fill-blank[data-blank="${+inp.dataset.blank+1}"]`); if (nx) nx.focus(); else document.getElementById('elFillSubmit').focus(); }
          if (e.key === 'Enter') { e.preventDefault(); document.getElementById('elFillSubmit').click(); }
        });
      });
      document.getElementById('elFillSubmit').addEventListener('click', () => {
        const blanks = screen.querySelectorAll('.fill-blank');
        let allCorrect = true;
        blanks.forEach(inp => {
          const idx = +inp.dataset.blank;
          if (inp.value.trim() === q.blanks[idx]) { inp.classList.add('correct'); }
          else { inp.classList.add('wrong'); allCorrect = false; inp.title = 'æ­£ç¡®ç­”æ¡ˆ: ' + q.blanks[idx]; inp.value = q.blanks[idx]; inp.style.fontSize = '.75rem'; }
          inp.disabled = true;
        });
        if (allCorrect) onCorrect(); else onWrong();
        const area = document.getElementById('elArea');
        addExplain(area, q.explain);
        addNextBtn(area);
        document.getElementById('elFillSubmit').remove();
      });
      showScreen('gameEndless');
    }
    return render;
  }

  // ---- BUGHUNTER endless ----
  function initBugHunterEndless() {
    resetPool(bugHunterData);
    function render() {
      const q = next(); questionNum++;
      screen.innerHTML = makeHeader() + `<div class="game-body">
        <div class="bughunter-wrap" style="max-width:550px;width:100%">
          <div class="bh-desc">ğŸ› ${q.desc}</div>
          <div class="bh-editor">
            <div class="bh-editor-header">
              <span class="dot" style="background:#ff5f57"></span>
              <span class="dot" style="background:#ffbd2e"></span>
              <span class="dot" style="background:#28ca41"></span>
              <span style="margin-left:.5rem">buggy_code.m</span>
            </div>
            <div class="bh-lines" id="elBHLines"></div>
          </div>
          <div id="elArea" style="margin-top:.8rem"></div>
        </div>
      </div>
      <div class="game-footer"><button class="btn btn-sm btn-cyan" id="elBHSubmit">æäº¤ï¼ˆç‚¹å‡»é€‰ä¸­æœ‰bugçš„è¡Œï¼‰</button></div>`;
      const linesEl = document.getElementById('elBHLines');
      const selected = new Set();
      q.code.forEach((line, idx) => {
        const el = document.createElement('div');
        el.className = 'bh-line';
        el.innerHTML = `<span class="bh-ln">${idx+1}</span><span class="bh-code">${escHtml(line)}</span>`;
        el.addEventListener('click', () => { el.classList.toggle('selected'); if (selected.has(idx)) selected.delete(idx); else selected.add(idx); });
        linesEl.appendChild(el);
      });
      document.getElementById('elBHSubmit').addEventListener('click', () => {
        linesEl.querySelectorAll('.bh-line').forEach(l => l.style.pointerEvents = 'none');
        let correct = selected.size === q.bugs.length && q.bugs.every(b => selected.has(b));
        q.bugs.forEach(b => linesEl.querySelectorAll('.bh-line')[b].classList.add('correct-bug'));
        if (correct) onCorrect(); else onWrong();
        const area = document.getElementById('elArea');
        addExplain(area, q.explain);
        addNextBtn(area);
        document.getElementById('elBHSubmit').remove();
      });
      showScreen('gameEndless');
    }
    return render;
  }

  // ---- MATRIX endless ----
  function initMatrixEndless() {
    let src = generateMatrixChallenges();
    pool = shuffle([...src]); poolIdx = 0;
    function render() {
      if (poolIdx >= pool.length) { src = generateMatrixChallenges(); pool = shuffle([...src]); poolIdx = 0; }
      const ch = pool[poolIdx++]; questionNum++;
      let matHtml = '<div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;justify-content:center">';
      matHtml += renderMatHtml(ch.matA, 'var(--cyan)');
      if (ch.op && ch.matB) { matHtml += `<span style="font-size:1.2rem;color:var(--orange)">${ch.op}</span>`; matHtml += renderMatHtml(ch.matB, 'var(--purple)'); }
      matHtml += '</div>';
      let inputHtml = '';
      if (ch.answerType === 'matrix') {
        const rows = ch.answer.length, cols = ch.answer[0].length;
        inputHtml = `<div class="matrix-grid" style="grid-template-columns:repeat(${cols},48px);margin-top:1rem;justify-content:center">` +
          ch.answer.map((r,ri) => r.map((c,ci) => `<input class="matrix-input-cell" data-r="${ri}" data-c="${ci}" type="number" style="width:48px;height:48px;background:var(--bg);border:1px solid #ffffff20;border-radius:6px;color:var(--text);text-align:center;font-family:'Fira Code';font-size:.9rem;outline:none">`).join('')).join('') + '</div>';
      } else {
        inputHtml = `<div style="margin-top:1rem;text-align:center"><input type="number" id="elMatScalar" style="width:120px;height:48px;background:var(--bg);border:1px solid #ffffff20;border-radius:6px;color:var(--text);text-align:center;font-family:'Fira Code';font-size:1rem;outline:none" placeholder="?"></div>`;
      }
      screen.innerHTML = makeHeader() + `<div class="game-body">
        <div class="matrix-wrap" style="max-width:550px;width:100%">
          <div style="font-size:.85rem;color:var(--text);margin-bottom:.8rem;text-align:center">${ch.question}</div>
          ${matHtml}
          ${inputHtml}
          <div id="elArea" style="margin-top:.8rem;text-align:center"></div>
        </div>
      </div>
      <div class="game-footer"><button class="btn btn-sm btn-cyan" id="elMatSubmit">æäº¤ç­”æ¡ˆ</button></div>`;
      document.getElementById('elMatSubmit').addEventListener('click', () => {
        let correct = true;
        if (ch.answerType === 'matrix') {
          screen.querySelectorAll('.matrix-input-cell').forEach(inp => {
            const r = +inp.dataset.r, c = +inp.dataset.c;
            if (+inp.value !== ch.answer[r][c]) { correct = false; inp.style.borderColor = 'var(--red)'; }
            else inp.style.borderColor = 'var(--green)';
            inp.disabled = true;
          });
        } else {
          const inp = document.getElementById('elMatScalar');
          if (+inp.value !== ch.answer) { correct = false; inp.style.borderColor = 'var(--red)'; }
          else inp.style.borderColor = 'var(--green)';
          inp.disabled = true;
        }
        if (correct) onCorrect(); else onWrong();
        const area = document.getElementById('elArea');
        if (!correct) {
          const ans = document.createElement('div');
          ans.style.cssText = 'margin-bottom:.5rem;font-family:"Fira Code";font-size:.85rem;color:var(--green)';
          ans.textContent = 'æ­£ç¡®ç­”æ¡ˆ: ' + (ch.answerType === 'matrix' ? '[' + ch.answer.map(r => r.join(' ')).join('; ') + ']' : ch.answer);
          area.appendChild(ans);
        }
        addExplain(area, ch.explain);
        addNextBtn(area);
        document.getElementById('elMatSubmit').remove();
      });
      showScreen('gameEndless');
    }
    return render;
  }

  function renderMatHtml(mat, color) {
    const rows = mat.length, cols = mat[0].length;
    let html = `<div class="matrix-grid" style="grid-template-columns:repeat(${cols},48px)">`;
    mat.forEach(row => row.forEach(v => { html += `<div class="matrix-cell" style="color:${color}">${v}</div>`; }));
    html += '</div>';
    return html;
  }

  // ---- CODEBUILDER endless ----
  function initCodeBuilderEndless() {
    resetPool(codeBuilderData);
    function render() {
      const ch = next(); questionNum++;
      ch.shuffled = shuffle([...ch.lines]);
      let dragIdx = null;
      screen.innerHTML = makeHeader() + `<div class="game-body">
        <div class="codebuilder-wrap" style="max-width:550px;width:100%">
          <div style="font-size:.85rem;color:var(--text);margin-bottom:.8rem">ğŸ“‹ ${ch.task}</div>
          <div id="elCBSlots"></div>
          <div id="elArea" style="margin-top:.8rem"></div>
        </div>
      </div>
      <div class="game-footer">
        <button class="btn btn-sm btn-green" id="elCBReset">ğŸ”„ é‡æ’</button>
        <button class="btn btn-sm btn-cyan" id="elCBSubmit" style="margin-left:.5rem">æäº¤</button>
      </div>`;
      function renderSlots() {
        const slotsEl = document.getElementById('elCBSlots');
        slotsEl.innerHTML = '';
        ch.shuffled.forEach((line, i) => {
          const slot = document.createElement('div');
          slot.className = 'code-slot';
          slot.draggable = true;
          slot.innerHTML = `<span class="slot-handle">â˜°</span><code>${escHtml(line)}</code>`;
          slot.addEventListener('dragstart', () => { dragIdx = i; slot.style.opacity = '.4'; });
          slot.addEventListener('dragend', () => { slot.style.opacity = '1'; });
          slot.addEventListener('dragover', e => { e.preventDefault(); slot.classList.add('drag-over'); });
          slot.addEventListener('dragleave', () => slot.classList.remove('drag-over'));
          slot.addEventListener('drop', e => {
            e.preventDefault(); slot.classList.remove('drag-over');
            if (dragIdx !== null && dragIdx !== i) {
              const temp = ch.shuffled[dragIdx]; ch.shuffled[dragIdx] = ch.shuffled[i]; ch.shuffled[i] = temp;
              renderSlots();
            }
          });
          // Touch support
          let touchStartY;
          slot.addEventListener('touchstart', e => { dragIdx = i; touchStartY = e.touches[0].clientY; slot.style.opacity = '.6'; });
          slot.addEventListener('touchmove', e => { e.preventDefault(); }, {passive:false});
          slot.addEventListener('touchend', e => {
            slot.style.opacity = '1';
            const endY = e.changedTouches[0].clientY;
            const diff = endY - touchStartY;
            if (Math.abs(diff) > 30) {
              const dir = diff > 0 ? 1 : -1;
              const target = i + dir;
              if (target >= 0 && target < ch.shuffled.length) {
                const temp = ch.shuffled[i]; ch.shuffled[i] = ch.shuffled[target]; ch.shuffled[target] = temp;
                renderSlots();
              }
            }
          });
          slotsEl.appendChild(slot);
        });
      }
      renderSlots();
      document.getElementById('elCBReset').addEventListener('click', () => { AudioEngine.play('click'); ch.shuffled = shuffle([...ch.lines]); renderSlots(); });
      document.getElementById('elCBSubmit').addEventListener('click', () => {
        let correct = ch.shuffled.every((l, i) => l === ch.lines[i]);
        if (correct) onCorrect(); else onWrong();
        const area = document.getElementById('elArea');
        if (!correct) {
          const box = document.createElement('div');
          box.style.cssText = 'padding:.8rem;background:#00ff8808;border:1px solid var(--green);border-radius:8px;margin-bottom:.5rem';
          box.innerHTML = '<div style="font-size:.7rem;color:var(--green);font-family:Orbitron;margin-bottom:.3rem">â–¾ æ­£ç¡®é¡ºåº</div>' +
            ch.lines.map((l,i) => `<div style="font-family:'Fira Code';font-size:.8rem;color:var(--text);padding:.2rem .4rem;background:var(--bg2);border-radius:4px;margin-bottom:2px"><span style="color:var(--green);margin-right:.4rem">${i+1}.</span>${escHtml(l)}</div>`).join('');
          area.appendChild(box);
        }
        addExplain(area, ch.explain);
        addNextBtn(area);
        document.getElementById('elCBSubmit').remove();
        document.getElementById('elCBReset').remove();
      });
      showScreen('gameEndless');
    }
    return render;
  }

  // ---- PLOT endless ----
  function initPlotEndless() {
    resetPool(plotData);
    function render() {
      const ch = next(); questionNum++;
      screen.innerHTML = makeHeader() + `<div class="game-body">
        <div style="max-width:550px;width:100%;text-align:center">
          <canvas id="elPlotCanvas" width="300" height="200" style="background:var(--bg);border:1px solid #ffffff15;border-radius:8px;max-width:100%"></canvas>
          <div class="plot-options" id="elArea" style="margin-top:1rem"></div>
        </div>
      </div>
      <div class="game-footer"><span style="font-size:.7rem;color:var(--text2)">é€‰æ‹©èƒ½ç”Ÿæˆæ­¤å›¾çš„å‘½ä»¤</span></div>`;
      const canvas = document.getElementById('elPlotCanvas');
      const ctx = canvas.getContext('2d');
      ch.draw(ctx, canvas.width, canvas.height);
      const area = document.getElementById('elArea');
      const opts = shuffle([...ch.options]);
      const correctIdx = opts.indexOf(ch.correct);
      opts.forEach((o, i) => {
        const opt = document.createElement('div');
        opt.className = 'plot-option'; opt.textContent = o;
        opt.addEventListener('click', () => {
          area.querySelectorAll('.plot-option').forEach(el => el.style.pointerEvents = 'none');
          if (o === ch.correct) { opt.classList.add('correct'); onCorrect(); }
          else { opt.classList.add('wrong'); onWrong(); area.querySelectorAll('.plot-option').forEach(el => { if (el.textContent === ch.correct) el.classList.add('correct'); }); }
          addExplain(area, ch.explain);
          addNextBtn(area);
        });
        area.appendChild(opt);
      });
      showScreen('gameEndless');
    }
    return render;
  }

  // ---- MAZE endless (choice questions only, no maze grid) ----
  function initMazeEndless() {
    resetPool(mazeQData);
    function render() {
      const q = next(); questionNum++;
      screen.innerHTML = makeHeader() + `<div class="game-body">
        <div class="output-wrap" style="max-width:550px">
          <div class="output-code-box">
            <div class="output-code-header">
              <span class="dot" style="background:#ff5f57;width:8px;height:8px;border-radius:50%"></span>
              <span class="dot" style="background:#ffbd2e;width:8px;height:8px;border-radius:50%"></span>
              <span class="dot" style="background:#28ca41;width:8px;height:8px;border-radius:50%"></span>
              <span style="margin-left:.5rem">maze_challenge.m</span>
            </div>
            <div class="output-code-body">${escHtml(q.code)}</div>
          </div>
          <div class="plot-options" id="elArea" style="margin-top:1rem"></div>
        </div>
      </div>
      <div class="game-footer"><span style="font-size:.7rem;color:var(--text2)">é€‰æ‹©æ­£ç¡®çš„è¾“å‡ºç»“æœ</span></div>`;
      const area = document.getElementById('elArea');
      q.options.forEach((o, i) => {
        const opt = document.createElement('div');
        opt.className = 'plot-option'; opt.textContent = o;
        opt.addEventListener('click', () => {
          area.querySelectorAll('.plot-option').forEach(el => el.style.pointerEvents = 'none');
          if (i === q.correct) { opt.classList.add('correct'); onCorrect(); }
          else { opt.classList.add('wrong'); onWrong(); area.querySelectorAll('.plot-option')[q.correct].classList.add('correct'); }
          addExplain(area, q.explain);
          addNextBtn(area);
        });
        area.appendChild(opt);
      });
      showScreen('gameEndless');
    }
    return render;
  }

  // Dispatch
  let renderNext;
  switch (modeId) {
    case 'terminal':    renderNext = initTerminalEndless(); break;
    case 'output':      renderNext = initOutputEndless(); break;
    case 'fill':        renderNext = initFillEndless(); break;
    case 'bughunter':   renderNext = initBugHunterEndless(); break;
    case 'matrix':      renderNext = initMatrixEndless(); break;
    case 'codebuilder': renderNext = initCodeBuilderEndless(); break;
    case 'plot':        renderNext = initPlotEndless(); break;
    case 'maze':        renderNext = initMazeEndless(); break;
    default:            renderNext = initTerminalEndless(); break;
  }
  renderNext();
}

// ===================== MODE 10: ENDLESS MODE (MULTI-TYPE) =====================
function initEndless() {
  const screen = document.getElementById('gameEndless');
  let totalScore = 0, streak = 0, bestStreak = 0, questionNum = 0;

  // Build unified question pool with MULTIPLE question types
  const allQuestions = [];

  // TYPE 1: choice - from mazeQData
  mazeQData.forEach(q => allQuestions.push({
    type: 'choice', category: 'è¾“å‡ºé¢„æµ‹',
    prompt: q.code, options: [...q.options], correct: q.correct, explain: q.explain
  }));

  // TYPE 2: terminal - keep as typing questions (original format!)
  terminalTasks.forEach(t => allQuestions.push({
    type: 'terminal', category: 'æé€Ÿç»ˆç«¯',
    prompt: t.prompt, answer: t.answer, alt: t.alt || [], explain: t.explain
  }));

  // TYPE 3: output - typing the output
  outputData.forEach(o => allQuestions.push({
    type: 'output', category: 'è¾“å‡ºé¢„æµ‹',
    code: o.code, answer: o.answer, altAnswers: o.altAnswers || [], explain: o.hint || ''
  }));

  // TYPE 4: fill - from fillData
  fillData.forEach(f => allQuestions.push({
    type: 'fill', category: 'ä»£ç å¡«ç©º',
    desc: f.desc, display: [...f.display], blanks: [...f.blanks], explain: f.explain
  }));

  // TYPE 5: bughunter - from bugHunterData
  bugHunterData.forEach(b => allQuestions.push({
    type: 'bughunter', category: 'BugçŒäºº',
    desc: b.desc, code: [...b.code], bugs: [...b.bugs], explain: b.explain
  }));

  // TYPE 6: choice - extra questions for variety
  const extraQuestions = [
    { prompt: 'A = magic(3);\ndisp(sum(A(:)))', options: ['45', '15', '34', '9'], correct: 0, explain: 'magic(3) ç”Ÿæˆ3é˜¶é­”æ–¹é˜µï¼Œæ‰€æœ‰å…ƒç´ ä¹‹å’Œ = 1+2+...+9 = 45ã€‚' },
    { prompt: 'x = [1 2 3 4 5];\ndisp(mean(x))', options: ['3', '5', '15', '2.5'], correct: 0, explain: 'mean æ±‚å¹³å‡å€¼ï¼š(1+2+3+4+5)/5 = 3ã€‚' },
    { prompt: 'A = [1 0; 0 1];\ndisp(rank(A))', options: ['2', '1', '0', '4'], correct: 0, explain: '2Ã—2å•ä½çŸ©é˜µçš„ç§© = 2ï¼Œå› ä¸ºä¸¤è¡Œ/åˆ—çº¿æ€§æ— å…³ã€‚' },
    { prompt: 'v = [3 1 4 1 5];\ndisp(median(v))', options: ['3', '1', '4', '2.5'], correct: 0, explain: 'median æ±‚ä¸­ä½æ•°ï¼šæ’åºå [1 1 3 4 5]ï¼Œä¸­é—´å€¼ä¸º3ã€‚' },
    { prompt: 'A = [1 2; 3 4];\nB = A.^2;\ndisp(B(2,1))', options: ['9', '3', '6', '4'], correct: 0, explain: '.^2 æ˜¯é€å…ƒç´ å¹³æ–¹ï¼š3^2 = 9ã€‚B(2,1) = 9ã€‚' },
    { prompt: 'x = pi;\ndisp(round(sin(x)))', options: ['0', '1', '-1', '3'], correct: 0, explain: 'sin(pi) â‰ˆ 0ï¼ˆæå°çš„æµ®ç‚¹æ•°ï¼‰ï¼Œround å››èˆäº”å…¥å = 0ã€‚' },
    { prompt: 'v = 1:10;\ndisp(v(end/2))', options: ['5', '10', '6', '1'], correct: 0, explain: 'v æœ‰10ä¸ªå…ƒç´ ï¼Œend=10ï¼Œend/2=5ï¼Œv(5)=5ã€‚' },
    { prompt: 'A = [1 2 3; 4 5 6];\ndisp(numel(A))', options: ['6', '2', '3', '5'], correct: 0, explain: 'numel è¿”å›çŸ©é˜µå…ƒç´ æ€»æ•°ã€‚2Ã—3 = 6ä¸ªå…ƒç´ ã€‚' },
    { prompt: 'x = -3;\ndisp(abs(x))', options: ['3', '-3', '0', '9'], correct: 0, explain: 'abs è¿”å›ç»å¯¹å€¼ï¼š|-3| = 3ã€‚' },
    { prompt: 'v = [10 20 30];\ndisp(fliplr(v))', options: ['[30 20 10]', '[10 20 30]', '[20 30 10]', 'é”™è¯¯'], correct: 0, explain: 'fliplr å·¦å³ç¿»è½¬å‘é‡/çŸ©é˜µï¼š[10 20 30] â†’ [30 20 10]ã€‚' },
    { prompt: 'A = [4 7; 2 6];\ndisp(trace(A))', options: ['10', '11', '6', '4'], correct: 0, explain: 'trace è¿”å›çŸ©é˜µçš„è¿¹ï¼ˆå¯¹è§’çº¿å…ƒç´ ä¹‹å’Œï¼‰ï¼š4+6 = 10ã€‚' },
    { prompt: 'x = 16;\ndisp(sqrt(x))', options: ['4', '8', '256', '2'], correct: 0, explain: 'sqrt æ±‚å¹³æ–¹æ ¹ï¼šâˆš16 = 4ã€‚' },
    { prompt: 'v = [2 4 6 8];\ndisp(cumsum(v))', options: ['[2 6 12 20]', '[2 4 6 8]', '[20 18 14 8]', '[8 6 4 2]'], correct: 0, explain: 'cumsum æ±‚ç´¯ç§¯å’Œï¼š[2, 2+4, 2+4+6, 2+4+6+8] = [2 6 12 20]ã€‚' },
    { prompt: 'A = zeros(3,2);\ndisp(size(A,1))', options: ['3', '2', '6', '0'], correct: 0, explain: 'size(A,1) è¿”å›ç¬¬1ä¸ªç»´åº¦ï¼ˆè¡Œæ•°ï¼‰= 3ã€‚' },
    { prompt: "s = 'Hello World';\ndisp(upper(s))", options: ['HELLO WORLD', 'hello world', 'Hello World', 'é”™è¯¯'], correct: 0, explain: 'upper å°†æ‰€æœ‰å­—æ¯è½¬ä¸ºå¤§å†™ã€‚' },
    { prompt: 'x = [true false true];\ndisp(sum(x))', options: ['2', '3', '1', 'true'], correct: 0, explain: 'MATLAB ä¸­ true=1, false=0ï¼Œsum æ±‚å’Œ = 1+0+1 = 2ã€‚' },
    { prompt: 'A = [1 2; 3 4];\ndisp(A(:))', options: ['[1;3;2;4]', '[1;2;3;4]', '[1 2 3 4]', '[4;3;2;1]'], correct: 0, explain: 'A(:) æŒ‰åˆ—å±•å¼€çŸ©é˜µä¸ºåˆ—å‘é‡ï¼šå…ˆç¬¬1åˆ—[1;3]å†ç¬¬2åˆ—[2;4] â†’ [1;3;2;4]ã€‚' },
    { prompt: 'x = 7;\ndisp(mod(x, 3))', options: ['1', '2', '0', '3'], correct: 0, explain: 'mod(7,3) = 7 é™¤ä»¥ 3 çš„ä½™æ•° = 1ã€‚' },
    { prompt: 'v = [5 3 8 1];\n[~, idx] = min(v);\ndisp(idx)', options: ['4', '1', '3', '2'], correct: 0, explain: 'æœ€å°å€¼1åœ¨ç¬¬4ä¸ªä½ç½®ï¼Œ~ å¿½ç•¥æœ€å°å€¼æœ¬èº«ï¼Œidx=4ã€‚' },
    { prompt: 'A = repmat([1 2], 2, 3);\ndisp(size(A))', options: ['[2 6]', '[4 6]', '[2 3]', '[1 2]'], correct: 0, explain: 'repmat å°† [1 2] æ²¿è¡Œå¤åˆ¶2æ¬¡ã€åˆ—å¤åˆ¶3æ¬¡ï¼š2è¡ŒÃ—(2Ã—3)=6åˆ— â†’ size = [2 6]ã€‚' },
  ];
  extraQuestions.forEach(q => allQuestions.push({
    type: 'choice', category: 'ç»¼åˆæŒ‘æˆ˜',
    prompt: q.prompt, options: q.options, correct: q.correct, explain: q.explain
  }));

  let pool = shuffle([...allQuestions]);
  let poolIdx = 0;

  function getNextQuestion() {
    if (poolIdx >= pool.length) {
      pool = shuffle([...allQuestions]);
      poolIdx = 0;
    }
    return pool[poolIdx++];
  }

  function makeHeader() {
    return makeGameHeader('æ— å°½æ¨¡å¼ â™¾ï¸', 'gameEndless',
      `<span class="game-score">å¾—åˆ†: ${totalScore}</span><span class="game-timer" style="color:var(--gold)">ğŸ”¥ ${streak}</span><span class="game-timer">æœ€ä½³: ${bestStreak}</span><span class="game-timer">#${questionNum}</span>`
    );
  }

  function addNextBtn(container) {
    const nextBtn = document.createElement('button');
    nextBtn.className = 'btn btn-sm btn-cyan';
    nextBtn.style.cssText = 'margin-top:.8rem';
    nextBtn.textContent = 'ä¸‹ä¸€é¢˜ â–¸';
    nextBtn.addEventListener('click', () => { AudioEngine.play('click'); renderEndless(); });
    container.appendChild(nextBtn);
  }

  function addExplain(container, text) {
    if (!text) return;
    const exp = document.createElement('div');
    exp.style.cssText = 'margin-top:.8rem;padding:.6rem;background:#ff660015;border-left:3px solid var(--orange);border-radius:0 6px 6px 0;font-size:.8rem;color:var(--text);line-height:1.5';
    exp.textContent = 'ğŸ’¡ ' + text;
    container.appendChild(exp);
  }

  function onCorrect() {
    AudioEngine.play('correct');
    streak++;
    if (streak > bestStreak) bestStreak = streak;
    const bonus = Math.min(streak, 5);
    totalScore += 10 + bonus;
    spawnParticles(window.innerWidth/2, window.innerHeight/2, '#00FF88', 15);
  }
  function onWrong() { AudioEngine.play('wrong'); streak = 0; }

  // ---- Render by question type ----

  function renderChoice(q) {
    screen.innerHTML = makeHeader() + `<div class="game-body">
      <div class="output-wrap" style="max-width:550px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
          <span style="font-size:.65rem;color:var(--cyan);font-family:Orbitron;letter-spacing:.1em">${q.category}</span>
          <span style="font-size:.65rem;color:var(--text2)">é€‰æ‹©é¢˜</span>
        </div>
        <div class="output-code-box">
          <div class="output-code-header">
            <span class="dot" style="background:#ff5f57;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#ffbd2e;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#28ca41;width:8px;height:8px;border-radius:50%"></span>
            <span style="margin-left:.5rem">challenge.m</span>
          </div>
          <div class="output-code-body">${escHtml(q.prompt)}</div>
        </div>
        <div class="plot-options" id="endlessArea" style="margin-top:1rem"></div>
      </div>
    </div>
    <div class="game-footer"><span style="font-size:.7rem;color:var(--text2)">è¿ç»­ç­”å¯¹é¢å¤–åŠ åˆ†</span></div>`;

    const area = document.getElementById('endlessArea');
    q.options.forEach((o, i) => {
      const opt = document.createElement('div');
      opt.className = 'plot-option'; opt.textContent = o;
      opt.addEventListener('click', () => {
        area.querySelectorAll('.plot-option').forEach(el => el.style.pointerEvents = 'none');
        if (i === q.correct) { opt.classList.add('correct'); onCorrect(); }
        else { opt.classList.add('wrong'); onWrong(); area.querySelectorAll('.plot-option').forEach(el => { if (el.textContent === q.options[q.correct]) el.classList.add('correct'); }); }
        addExplain(area, q.explain);
        addNextBtn(area);
      });
      area.appendChild(opt);
    });
  }

  function renderTerminal(q) {
    screen.innerHTML = makeHeader() + `<div class="game-body">
      <div style="max-width:550px;width:100%">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
          <span style="font-size:.65rem;color:var(--cyan);font-family:Orbitron;letter-spacing:.1em">æé€Ÿç»ˆç«¯</span>
          <span style="font-size:.65rem;color:var(--text2)">è¾“å…¥å‘½ä»¤</span>
        </div>
        <div class="terminal-wrap" style="background:var(--bg);border:1px solid #ffffff15;border-radius:8px;padding:1rem;max-height:none">
          <div style="font-size:.75rem;color:var(--text2);margin-bottom:.8rem;font-family:'Fira Code'">% ${escHtml(q.prompt)}</div>
          <div style="display:flex;align-items:center;gap:.5rem">
            <span style="color:var(--green);font-family:'Fira Code';font-size:.85rem">>></span>
            <input type="text" id="endlessTermInput" style="flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'Fira Code';font-size:.85rem;caret-color:var(--orange)" autocomplete="off" autocorrect="off" spellcheck="false">
          </div>
          <div id="endlessArea" style="margin-top:.8rem"></div>
        </div>
      </div>
    </div>
    <div class="game-footer"><span style="font-size:.7rem;color:var(--text2)">è¾“å…¥ MATLAB å‘½ä»¤åæŒ‰ Enter</span></div>`;

    const input = document.getElementById('endlessTermInput');
    const area = document.getElementById('endlessArea');
    setTimeout(() => input.focus(), 100);

    let answered = false;
    input.addEventListener('keydown', e => {
      if (e.key !== 'Enter' || answered) return;
      answered = true;
      const val = input.value.trim().replace(/;$/, '');
      const correct = val === q.answer || val === q.answer + ';' || (q.alt && q.alt.includes(val)) || (q.alt && q.alt.includes(val + ';'));
      input.disabled = true;
      const fb = document.createElement('div');
      fb.style.cssText = 'font-family:"Fira Code";font-size:.85rem;margin-top:.3rem';
      if (correct) {
        fb.innerHTML = '<span style="color:var(--green)">âœ“ æ­£ç¡®ï¼</span>';
        onCorrect();
      } else {
        fb.innerHTML = `<span style="color:var(--red)">âœ— é”™è¯¯</span><span style="color:var(--text2);margin-left:.5rem">æ­£ç¡®ç­”æ¡ˆ: <span style="color:var(--green)">${escHtml(q.answer)}</span></span>`;
        onWrong();
      }
      area.appendChild(fb);
      addExplain(area, q.explain);
      addNextBtn(area);
    });
  }

  function renderOutput(q) {
    screen.innerHTML = makeHeader() + `<div class="game-body">
      <div class="output-wrap" style="max-width:550px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
          <span style="font-size:.65rem;color:var(--cyan);font-family:Orbitron;letter-spacing:.1em">è¾“å‡ºé¢„æµ‹</span>
          <span style="font-size:.65rem;color:var(--text2)">è¾“å…¥è¾“å‡º</span>
        </div>
        <div class="output-code-box">
          <div class="output-code-header">
            <span class="dot" style="background:#ff5f57;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#ffbd2e;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#28ca41;width:8px;height:8px;border-radius:50%"></span>
            <span style="margin-left:.5rem">predict.m</span>
          </div>
          <div class="output-code-body">${escHtml(q.code)}</div>
        </div>
        <div style="margin-top:1rem;display:flex;gap:.5rem;align-items:center">
          <span style="font-size:.8rem;color:var(--text2)">è¾“å‡º =</span>
          <input type="text" id="endlessOutputInput" style="flex:1;background:var(--bg);border:1px solid #ffffff20;border-radius:6px;padding:.5rem .8rem;color:var(--text);font-family:'Fira Code';font-size:.85rem;outline:none" autocomplete="off" placeholder="è¾“å…¥ç¨‹åºè¾“å‡º...">
          <button class="btn btn-sm btn-cyan" id="endlessOutputSubmit">æäº¤</button>
        </div>
        <div id="endlessArea" style="margin-top:.8rem"></div>
      </div>
    </div>
    <div class="game-footer"><span style="font-size:.7rem;color:var(--text2)">é¢„æµ‹ä»£ç çš„è¾“å‡ºç»“æœ</span></div>`;

    const input = document.getElementById('endlessOutputInput');
    const submitBtn = document.getElementById('endlessOutputSubmit');
    const area = document.getElementById('endlessArea');
    setTimeout(() => input.focus(), 100);

    let answered = false;
    function doSubmit() {
      if (answered) return;
      answered = true;
      const val = input.value.trim();
      const alts = q.altAnswers || [];
      const correct = val === q.answer || alts.includes(val);
      input.disabled = true; submitBtn.disabled = true;
      const fb = document.createElement('div');
      fb.style.cssText = 'font-size:.85rem;margin-top:.3rem';
      if (correct) {
        fb.innerHTML = '<span style="color:var(--green)">âœ“ æ­£ç¡®ï¼</span>';
        onCorrect();
      } else {
        fb.innerHTML = `<span style="color:var(--red)">âœ— é”™è¯¯</span> <span style="color:var(--text2)">æ­£ç¡®ç­”æ¡ˆ: <span style="color:var(--green)">${escHtml(q.answer)}</span></span>`;
        onWrong();
      }
      area.appendChild(fb);
      addExplain(area, q.explain);
      addNextBtn(area);
    }
    submitBtn.addEventListener('click', doSubmit);
    input.addEventListener('keydown', e => { if (e.key === 'Enter') doSubmit(); });
  }

  function renderFill(q) {
    let blankIdx = 0;
    let codeHtml = '';
    q.display.forEach(line => {
      let processed = escHtml(line);
      while (processed.includes('&lt;BLANK&gt;')) {
        processed = processed.replace('&lt;BLANK&gt;',
          `<input class="fill-blank" data-blank="${blankIdx}" placeholder="?" style="width:${Math.max(60, q.blanks[blankIdx].length * 12)}px">`);
        blankIdx++;
      }
      codeHtml += processed + '\n';
    });

    screen.innerHTML = makeHeader() + `<div class="game-body">
      <div class="fill-wrap" style="max-width:550px;width:100%">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
          <span style="font-size:.65rem;color:var(--cyan);font-family:Orbitron;letter-spacing:.1em">ä»£ç å¡«ç©º</span>
          <span style="font-size:.65rem;color:var(--text2)">å¡«å…¥ç©ºç™½</span>
        </div>
        <div class="fill-desc">âœï¸ ${q.desc}</div>
        <div class="fill-code-box">
          <div class="output-code-header">
            <span class="dot" style="background:#ff5f57;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#ffbd2e;width:8px;height:8px;border-radius:50%"></span>
            <span class="dot" style="background:#28ca41;width:8px;height:8px;border-radius:50%"></span>
            <span style="margin-left:.5rem">fill_blanks.m</span>
          </div>
          <div class="fill-code-body" id="fillCodeEndless">${codeHtml}</div>
        </div>
        <div id="endlessArea" style="margin-top:.8rem"></div>
      </div>
    </div>
    <div class="game-footer">
      <button class="btn btn-sm btn-cyan" id="endlessFillSubmit">æäº¤ç­”æ¡ˆ</button>
    </div>`;

    const firstBlank = screen.querySelector('.fill-blank[data-blank="0"]');
    if (firstBlank) setTimeout(() => firstBlank.focus(), 100);

    screen.querySelectorAll('.fill-blank').forEach(inp => {
      inp.addEventListener('keydown', e => {
        if (e.key === 'Tab') { e.preventDefault(); const next = screen.querySelector(`.fill-blank[data-blank="${+inp.dataset.blank+1}"]`); if (next) next.focus(); else document.getElementById('endlessFillSubmit').focus(); }
        if (e.key === 'Enter') { e.preventDefault(); document.getElementById('endlessFillSubmit').click(); }
      });
    });

    document.getElementById('endlessFillSubmit').addEventListener('click', () => {
      const blanks = screen.querySelectorAll('.fill-blank');
      let allCorrect = true;
      blanks.forEach(inp => {
        const idx = +inp.dataset.blank;
        if (inp.value.trim() === q.blanks[idx]) { inp.classList.add('correct'); }
        else { inp.classList.add('wrong'); allCorrect = false; inp.title = 'æ­£ç¡®ç­”æ¡ˆ: ' + q.blanks[idx]; inp.value = q.blanks[idx]; inp.style.fontSize = '.75rem'; }
        inp.disabled = true;
      });
      if (allCorrect) onCorrect(); else onWrong();
      const area = document.getElementById('endlessArea');
      addExplain(area, q.explain);
      addNextBtn(area);
      document.getElementById('endlessFillSubmit').remove();
    });
  }

  function renderBugHunter(q) {
    screen.innerHTML = makeHeader() + `<div class="game-body">
      <div class="bughunter-wrap" style="max-width:550px;width:100%">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
          <span style="font-size:.65rem;color:var(--cyan);font-family:Orbitron;letter-spacing:.1em">BugçŒäºº</span>
          <span style="font-size:.65rem;color:var(--text2)">æ‰¾å‡ºbug</span>
        </div>
        <div class="bh-desc">ğŸ› ${q.desc}</div>
        <div class="bh-editor">
          <div class="bh-editor-header">
            <span class="dot" style="background:#ff5f57"></span>
            <span class="dot" style="background:#ffbd2e"></span>
            <span class="dot" style="background:#28ca41"></span>
            <span style="margin-left:.5rem">buggy_code.m</span>
          </div>
          <div class="bh-lines" id="endlessBHLines"></div>
        </div>
        <div id="endlessArea" style="margin-top:.8rem"></div>
      </div>
    </div>
    <div class="game-footer">
      <button class="btn btn-sm btn-cyan" id="endlessBHSubmit">æäº¤ï¼ˆç‚¹å‡»é€‰ä¸­æœ‰bugçš„è¡Œï¼‰</button>
    </div>`;

    const linesEl = document.getElementById('endlessBHLines');
    const selected = new Set();
    q.code.forEach((line, idx) => {
      const el = document.createElement('div');
      el.className = 'bh-line';
      el.innerHTML = `<span class="bh-ln">${idx + 1}</span><span class="bh-code">${escHtml(line)}</span>`;
      el.addEventListener('click', () => {
        if (el.style.pointerEvents === 'none') return;
        el.classList.toggle('selected');
        if (selected.has(idx)) selected.delete(idx); else selected.add(idx);
      });
      linesEl.appendChild(el);
    });

    document.getElementById('endlessBHSubmit').addEventListener('click', () => {
      const lines = linesEl.querySelectorAll('.bh-line');
      lines.forEach(l => l.style.pointerEvents = 'none');
      let correct = selected.size === q.bugs.length && q.bugs.every(b => selected.has(b));
      q.bugs.forEach(b => lines[b].classList.add('correct-bug'));
      if (correct) onCorrect(); else onWrong();
      const area = document.getElementById('endlessArea');
      addExplain(area, q.explain);
      addNextBtn(area);
      document.getElementById('endlessBHSubmit').remove();
    });
  }

  // ---- Main render dispatcher ----
  function renderEndless() {
    const q = getNextQuestion();
    questionNum++;

    switch (q.type) {
      case 'choice':    renderChoice(q); break;
      case 'terminal':  renderTerminal(q); break;
      case 'output':    renderOutput(q); break;
      case 'fill':      renderFill(q); break;
      case 'bughunter': renderBugHunter(q); break;
      default:          renderChoice(q); break;
    }
    showScreen('gameEndless');
  }

  renderEndless();
}

// ===================== UTILITY =====================
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===================== INIT =====================
// Splash is set active via HTML class, no additional init needed
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/v67327c56f0bb4ef8b305cae61679db8f1769101564043" integrity="sha512-rdcWY47ByXd76cbCFzznIcEaCN71jqkWBBqlwhF1SY7KubdLKZiEGeP7AyieKZlGP9hbY/MhGrwXzJC/HulNyg==" data-cf-beacon='{"version":"2024.11.0","token":"75124c326cb447fe934cde04713ae013","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
